# NoSQL
- RDBMS: 엔티티간의 관계에 중점을 두고 테이블 구조를 설계하는 방식
- 관계형 DB가 아닌 다른 형태의 데이터 저장기술
- 데이터 간의 관계를 정의하지 않는다, 데이터 테이블은 하나의 테이블이며, 각 테이블 간의 관계를 정의하지도 않고 일반적으로 테이블 간의 조인도 불가능하다.
- RDBMS에 비해 훨씬 더 대용량의 데이터를 저장할 수 있다.
- 하나의 고성능 머신에 데이터를 저장하는 것이 아니라, 일반적인 서버 수십 대를 연결하여 데이터를 저장 및 처리하는 구조를 갖는다. 분산 시에 데이터를 상호 복제하여 특정 서버가 장애가 나도 데이터 유실이나 서비스 중지가 없는 형태의 구조이다.
- RDBMS와는 다르게 테이블의 스키마가 유동적이다. 키 부분에만 타입이 동일하고 생략되지 안는 필드로 지정하면 값에 해당하는 칼럼은 어떤 타입이든 어떤 이름이 오든 모두 허용된다.
- 완벽한 데이터 무결성과 정확성을 제공하지 않는다.
- 핵심 데이터는 RDBMS를 이용, 핵심은 아니지만 데이터를 보관 및 처리하는경우 NoSQL이용

## CAP 이론
- 분산 컴퓨팅 환경은 일관성(Consistency), 가용성(Availability), 분산 허용(Partitioning Tolerance)의 3가지 특징을 가지고 있으며, 이중 두가지만 만족할 수 있다는 이론이다.
- 일관성: 분산된 노드중 어느 노드로 접근하더라도 데이터 값이 같아야한다는 특징
- 가용성: 클러스터링된 노드 중 하나 이상의 노드가 실패라도 정상적으로 요청을 처리할 수 잇는 기능을 제공하는 특징
- 분산 허용: 클러스터링 노드 간에 통신하는 네트워크가 장애가 나더라도 정상적으로 서비스를 수행할 수 있는 기능

## 분류

### key/value store
- 가장 기본적인 패턴
- 고유한 키에 하나의 값을 가진 형태를 의미
- Value는 string이나 integer와 같은 primitive 타입이 될 수도 있지만, Column Family라는 개념도 존재한다.
- Column Family: key안에 (column, value) 조합으로 된 여러 개의 필드를 갖는것을 의미

### Ordered key/value store
- 키/값 저장 방식과 동일하나 데이터가 내부적으로 키를 순서로 정렬해서 저장한다.
- NoSQL은 Order by와 같은 기능을 제공하지 않기 때문에 이러한 방식은 중요하다
- Hbase, Cassandra등이 있다.

### Document key/value store
- 키/값 저장방식의 확장 형태로, 저장되는 데이터 타입으로 Document라는 타입을 사용한다. Document는 XML, JSON, YAML과 같이 구조화된 데이터 타입을 일컫는 것이다.
- 대부분 추가적인 (Sorting, Join, Grouping등)을 제공한다.
- MongoDB, CouchDB등이 있다.

### 기타
- 그래프나 트리 구조와 같은 데이터 구조를 저장하는 데 최적화된 Neo4J가 존재한다.

## NoSQL과 RDMS의 차이
- NoSQL은 데이터를 저장하고 키에 대한 put/get만 지원한다.
- Sorting, Join, Grouping, Range Query, Index등이 NoSQL에서는 대부분 지원되지 않는다.

## NoSQL 사용시 주의점
- NoSQL은 데이터 모델링이 설계의 90%다.
- RDMBS와 NoSQL을 혼합하여 사용하는 설계가 좋다.
- NoSQL을 사용할 때는 처음부터 하드웨어 설계를 병행하는 것이 좋다.

## NoSQL 데이터 모델링
- 쿼리 결과를 먼저 설계한 후에 중복을 허용하여 데이터를 저장하는 테이블 구조를 정의한다.

### NoSQL과 RDBMS의 데이터 모델링 차이
- 객체 모델 지향에서 쿼리 결과 지향 모델링으로 변화시켜야한다. NoSQL의 경우 복잡한 쿼리 기능이 없기 때문에 어떤 쿼리 결과가 필요한지를 정의한 후에 이 쿼리를 얻기 위한 데이터 저장 모델을 디자인해야한다. RDBMS의 모델링은 저장하고자 하는 도메인 모델을 먼저 분석한 후에 개체 간의 관계를 식별하고 테이블을 추출해내고 테이블을 이용하여 쿼리를 구현하여 결과를 뽑는다.
- RDBMS에서는 데이터의 일관성과 도메인 모델과의 일치성을 위해서 데이터 모델을 정규화 한다. 같은 데이터가 두개 이상의 테이블에 중복 저장하는 것을 제거한다. NoSQL은 반대로 쿼리의 효율성을 위해서 데이터를 정규화하지 않고 의도적으로 중복된 데이터를 저장하는 등의 비정규화된 데이터 모델 방식으로 접근해야 한다.

### NoSQL 데이터 모델링 패턴

### 역정규화
- 같은 데이터를 중복해서 저장하는 방식, 역정규화를 하면 테이블 간의 조인을 없앨 수 있다. 
- 역정규화를 적용하여 하나의 테이블에 조인될 데이터를 중복 저장하게 되면 1번의 I/O로도 데이터를 가져올 수 있다. 
- 장점: 조인을 위해서 여러번 쿼리를 하지 않기때문에 쿼리 성능이 올라간다, 조인에 대한 로직이 필요 없으므로 쿼리 로직이 단순해진다.
- 단점: 데이터 일관성 문제 발생할 수 있다. 데이터를 중복해서 저장하므로 스토리지 용량이 증가한다.

### 집계
- Schemeless: 키만 똑같다면 각 행은 제멋대로 해도 된다. 같은 칼럼과 데이터 타입을 가질 필요가 없다. 데이터 구조는 가지고 있지만 구조가 각각 다른 것을 허용한다.
- 1:N과 같은 복잡한 엔티티들의 관계를 손쉽게 하나의 테이블로 바꿀 수 있고, 결과적으로 조인의 수를 줄여서 쿼리 성능을 높인다.

### 애플리케이션 조인
- 조인이 거의 불가능하다 그러나 어쩔수 없이 조인을 수행해야 할 경우가 있다. NoSQL의 쿼리로는 불가능하고, NoSQL을 사용하는 클라이언트 애플리케이션 단에서 로직으로 처리해줘야 한다.
- 조인이 필요한 테이블 수 만큼 NoSQL로의 요청/응답 I/O가 발생하지만, 역정규화등에 비해서는 스토리지 사용량을 절약할 수 있다.

### 맵리듀스 기능을 이용한 서버 조인
- 일부 NoSQL DB들은 RDBMS의 Stored Procedure와 같은 기능(프로그래밍 언어를 이용해 구현된 사용자 정의 데이터 쿼리 함수)을 지원하는데, 이것을 맵리듀스라는 이름으로 지원한다.
- 애플리케이션에서 수행한 로직을 NoSQL 서버들 내에서 수행해서 반환하는 방식, 이 로직들은 NoSQL에서 지원하는 언어를 통해서 구현된 후 NoSQL 엔진 위에서 수행된다.
- 애플리케이션에서 NoSQL로의 호출이 맵리듀스 함수 한번만 호출하면 되기 때문에 네트워크 I/O를 줄여서 성능을 향상시킬수 있다.
- 반면, 조인에 대한 로직이 NoSQL 서버 쪽에서 수행되기 때문에 반대로 NoSQL에 대한 부담이 가중된다.

### Atomic Aggregation
- 두 개 이상의 테이블을 업데이트 할 때 트랜잭션 관리에 대한 문제가 있다. 1번 테이블을 업데이트 한후, 2번 테이블에 대한 업데이트가 장애등의 문제로 안될수도 있다. 이럴 경우 테이블 1,2를 하나로 합치는 것이다. 하나의 테이블에 대해서는 NoSQL도 원자성을 보장하기 때문에 트랜잭션을 보장받을 수 있다.
- 트랜잭션 보장을 통한 데이터 불일치성을 해결하기 위함이다.

### Index table
- 인덱스가 없기 때문에 키 이외의 필드를 이용하여 검색하면 전체 테이블을 전체 스캔을 하거나 아니면 키 이외의 필드에 대해서는 검색이 불가능 하다.
- 인덱스를 위한 별도의 인덱스 테이블을 만들어서 사용할수 있다.

### Composite key
- `:`를 이용하여 복합키를 사용한다.
- 하나 이상의 필드를 deliminator를 이용하여 구분 지어 사용하는 방법으로 RDBMS의 복합키와 같은 개념이다.
- RDBMS는 여러 개의 칼럼을 묶어서 PK로 지정하지만 NoSQL은 한 칼럼에 구분자를 이용하여 여러개의 키를 묶어서 넣는다.
- NoSQL 특성상 N 개의 서버로 구성된 클러스터이다. 그리고 데이터는 키를 기준으로 N 개의 서버에 나눠서 저장되는데 키 값에 따라 특정 서버로의 몰림 현상이 나타날 수 있다.

### Inverted Search Index
- 값의 내용을 키로 하고 반대로 키의 내용을 값으로 하는 패턴

### Enumerable keys
- 일부 NoSQL은 Sequence 기능을 제공하는데, 키에 대해서 자동으로 카운터를 올려주는 역할을 한다.
- 이 기능은 데이터에 대한 트래버스 기능을 제공한다.

## NoSQL 데이터 모델링 절차

### 도메인 모델 파악
- 어떤 데이터 개체가 있는지 개체간의 관계는 어떻게 되는지 등을 분석한다.

### 쿼리 결과 디자인
- 도메인 모델을 기반으로 애플리케이션에 의해서 쿼리 되는 결과값을 먼저 정해야 한다.

### 패턴을 이용한 데이터 모델링
- Put/Get으로만 데이터를 가지고 올 수 있는 형태로 데이터 모델과 테이블을 다시 정의해야 한다.

### 후보 NoSQL 선정과 테스트
- NoSQL에 대한 구조 및 특성을 분석한후 부하 테스트, 안정성, 확장성 테스트를 거친후에 적절한 것을 선택해야 한다.
- 다수의 NoSQL을 사용할 수도 있다.

### 데이터 모델을 선정한 NoSQL에 최적화 및 하드웨어 디자인
- 선정된 NoSQL을 기반으로 다시 데이터 모델을 최적화하고 이에 맞는 애플리케이션 인터페이스 설계와 하드웨어에 대한 디자인을 해야한다.