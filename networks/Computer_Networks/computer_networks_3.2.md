# 패킷 교환

## 브리지와 LAN 스위치
- 두개의 이더넷을 서로 연결하기 위한 한가지 방법은 두 네트워크 사이에 리피터를 두는 방식이다. 이더넷이 물리적인 제한을 넘어선다면 사용할수 없다.
- 다른 방식으로는 두 이더넷 사이에 노드를 두고 그 노드로 하여금 한 이더넷에서 다른 이더넷으로 프레임을 포워드하도록 하는 것이다. 이 노드는 양쪽 이더넷으로부터 모든 프레임을 받는 무차별 모드에서 동작해야하며, 그래야만 프레임을 다른 이더넷으로 포워드할 수 있다. 이것을 `브릿지`라고 한다. 또한 하나 또는 그 이상의 브리지에 의하여 연결된 LAN의 집단을 `확장 집단`이라 한다.
- 가장 간단한 형태의 브리지는 입력으로 프레임을 수신해서 모든 출력으로 그들을 포워드한다. 브리지는 교환기의 정의인 복수개의 입력과 복수 개의 출력을 가지며 한쪽에서 입력된 패킷을 하나 또는 그 이상의 출력으로 전달하는 장치라는 정의를 만족한다. 그리고 이것이 네트워크의 전체 대역폭을 늘리는 방법을 제공한다는 점이다.

### 학습 브리지
- 브리지가 모든 프레임을 받아서 포워딩할 필요가 없다는 것에 착안하여 발전한 형태
- 브리지가 호스트들이 어느 포트에 접속되어 있는지를 알수 있는 방법은 중 하나는 테이블을 브리지에 정의하는 방식이다. 이러한 테이블을 사용하는 브리지는 데이터그램 포워딩 모델을 적용하고 있다. 각 패킷은 전역주소를 담고 있으며, 브리지는 테이블에 있는 주소를 찾아 봐서 어느 출력으로 패킷을 보낼지를 결정한다.
- 브리지가 자신이 수신한 모든 프레임의 출발 주소를 조사한다. 이것을 통하여 테이블을 구축한다. 또한 테이블의 각 항목은 일정 시간이 되면 제거된다.
- 현재 테이블에 등록되어 있지 않은 주소로 프레임을 수신하면 브리지는 그 프레임이 수신된 포트를 제외한 나머지 모든 포트로 이 프레임을 전송한다. 이 테이블은 단순 어떤 프레임을 제거하려는 최선의 시도를 하는 것이지 항상 정확한 동작만을 하는 것은 아니다.
- 브리지 테이블을 완벽히 만드는 것은 정확한 포워딩을 위해 필요한 것이 아니고 단지 성능을 최적화해 준다는 점이다.

### 스패닝 트리 알고리즘
- 학습 브리지 기법은 확장 LAN이 루프를 갖지 않은 경우에는 잘 동작한다. 그러나 루프가 있을 경우 프레임이 확장 LAN상의 루프를 따라 영원히 순환하게 될 가능성이 있다.
- 확장 LAN이 사이클을 가질수 있는 그래프로 표현된다면, 스패닝 트리를 사용할수 있다.
- 스패닝 트리: 그래프의 모든 정점을 포함하고 루프를 갖지 않는 부그래프. 즉, 원래의 그래프에서 정점은 간직하고 일부 에지를 제거한다.
- 각 브리지가 어떤 포트로 프레임을 전송하고, 어떤 포트로는 전송하지 않을 것인가를 결정하는 것을 의미하는 것이며 확장 LAN이 비순환 트리로 줄어들도록 네트워크 토폴로지에서 몇몇 포트를 제거한다는 뜻이다.
- 이 알고리즘은 동적이여서 브리지들은 만일 어느 브리지에 장애가 발생하면, 새로운 스패닝 트리를 스스로 재구성할수 있다.

#### 작동 방식
- 각 브리지는 고유한 식별자를 가진다. 알고리즘은 먼저 가장 작은 식별자를 스패닝 트리의 루트로 선택한다.
- 루트 브리지는 자신의 모든 포트로 프레임을 전송한다.
- 각 브리지는 루트로 가는 최단 경로를 계산하고 이 경로상의 포트를 지정한다. 이 포트는 루트로 가는 우선경로로 선택된다는 의미이다.
- 각 LAN에 연결된 브리지는 루트로 프레임을 포워딩하는 책임을 갖는 하나의 지정 브리지를 선정한다. 각 LAN의 지정 브리지는 루트에 가장 가까운 브리지이며, 두 개 이상의 브리지가 루트로부터 같은 거리에 있을 경우에는 식별자가 작은 브리지가 선택된다. 브리지가 여러 LAN에 연결되어 있는 경우에는 그 브리지는 연결된 각각의 LAN의 지정 브리지 선정에 참여한다. 각 브리지는 각각의 포트에 대하여 자신이 지정 브리지인지를 결정한다는 의미이다.
- 브리지는 자신이 지정 브리지로 선택되어 있는 포트로만 프레임을 전송한다.
- 확장 LAN 내의 브리지의 관점에서는 전체 네트워크의 구성을 파악하고 다른 브리지의 식별자를 확인하거나 내부를 볼 수 있는 방법은 없다. 그러므로 브리지는 구성 메시지를 교환하고, 이 메시지를 바탕으로 자신이 루트인지 지정 브리지인지를 판단한다.

#### 구성 메시지
- 메시지를 송신하는 브리지의 식별자, 송신 브리지가 루트 브리지로 믿고 있는 브리지의 식별자, 송신 브리지로부터 루트 브리지까지의 홉의 수로 표현된거리를 포함한다.
- 각 브리지는 다른 브리지로부터 수신된 메시지와 브리지 자신이 송신한 메시지를 포함하여 자신의 각 포트에서 관찰된 구성 메시지중 최선의 구성 메시지를 기록한다.
- 초기에는 각 브리지가 자신이 루트라고 생각하고, 자신이 루트이며 루트와의 거리는 0이라는 내용의 메시지를 각 포트로 전송한다. 특정 포트로 구성 메시지를 수신한 브리지는 수신된 구성 메시지가 그 포트에 기록된 최선의 구성 메시지와 비교하여 좋은지를 점검한다.
- 새로운 구성메시지가 현재 기록된 것보다 좋다는 의미는 보자 작은 식별자 루트를 지정한다, 같은 식별자의 루트를 지정하지만 거리가 더 짧다, 같은 식별자와 같은 거리를 가지지만 송신 브리지 식별자가 더 작다는 것을 근거로 한다.
- 만일 새로운 메시지가 현재 기록된 정보보다 좋을 경우, 브리지는 현재의 정보를 제거하고 새로운 정보를 저장한다. 그러나 브리지가 그 메시지를 송신한 브리지보다는 한 홉만큼 떨어져 있으므로 루트로의 거리에는 1을 더한 값을 저장한다.
- 어떤 브리지가 자신이 루트가 아니라는 내용의 구성 메시지, 즉 자신보다 작은 식별자를 가진 브리지로부터 구성 메시지를 수신한 경우에, 그 브리지는 구성 메시지의 생성을 중단하고 다른 브리지로부터의 구성 메시지를 포워딩하는 역할만을 수행한다.
- 어떤 포트의 지정 브리지가 아니라는 내용의 메시지르, 즉 루트로의 거리가 가깝거나 거리가 같고 작은 식별자를 가진 브리지로부터 구성 메시지를 수신한 경우, 브리지는 해당 포트로 구성 메시지 전송을 중단한다.
- 시스템이 안정화되고 나면, 루트 브리지만이 구성 메시지를 생성하고, 다른 브리지들은 구성메시지를 자신의 지정 브리지로 선정되어 있는 포트로만 포워딩하게 된다.
- 어떤 브리지에 장애가 발생되어 하위 브리지가 구성 메시지를 받지 못하게 된 후 일정 시간이 되면, 하위 브리지는 다시 자신을 루트로 선언하고 앞에 방식을 따라 새로운 루트와 새로운 지정 브리지를 선출하는 기능을 수행한다.

### 방송 및 멀티캐스트
- 브리지는 하나의 LAN을 여러 개의 네트워크에 걸쳐 투명하게 확장하는 것이며, 브리지는 이를 위해 방송(브로드캐스트)와 멀티캐스트를 지원해야 한다.
- 방송은 각 브리지가 방송 주소를 가진 모든 프레임을 그 프레임이 도착한 포트를 제외한 모든 활성 포트로 재전송하면 된다.
- 스패닝 트리 알고리즘은 멀티캐스트 프레임이 포워딩될 필요가 없는 네트워크를 제거하는 기능을 수행하도록 개선될 수 있다.

#### 멀티캐스트 방식
- 브리지는 유니캐스트 프레임을 특정 포트로 포워딩할지 여부를 학습하는 방법은 그 포트로 수신되는 프레임의 발신지 주소를 관찰하는 방식과 같은 방법으로 학습한다.
- 그룹 주소는 일반적으로 발신지 주소와 같지 않으므로 그룹에 속한 각 호스트는 주기적으로 프레임 헤더의 발신지 주소항에 그룹의 주소를 실은 프레임을 전송한다. 이 프레임은 브리지에게 수신지 주소로 사용될 멀티캐스트 주소를 알려 주는 기능을 한다.

### 브리지의 한계

#### 비례 확장성 문제
- 브리지를 이용하여 수십 개 이상의 LAN을 연결하는 것은 비현실적이다. 스패닝 트리 알고리즘의 복잡성은 선형적으로 증가한다. 즉, 확장 LAN에 계층 개념을 도입하지 않고 있다는 것이다. 또한, 모든 방송 프레임을 재전송한다는 것이다. 제한된 구성에서는 모든 호스트가 서로의 방송 메시지를 수신하는 것이 현실적으로 가능할 수도 있으나, 대규모 환경에서 모든 호스트가 서로의 방송 메시지를 들으려고 하는 경우는 극히 드물다. 방송은 확장성이 없으며, 결과적으로 확장 LAN도 확장성이 없다.
- 확장 LAN이 확장서을 증대시키는 방법 중의 하나는 `가상 LAN(VLAN)`이다. VLAN은 하나의 확장 LAN이 여러 개의 별도 LAN으로 보이도록 분할되게 해준다. 각 가상 LAN에는 식별자가 할당되며, 패킷은 한 쪽 세그먼트에서 다른 세그먼트로 양쪽 세그먼트가 같은 식별자를 가질때만 이동될 수 있다. 이점 때문에 확장 LAN에서 주어진 방송 패킷을 수신하는 세그먼트의 수가 제한된다.
- VLAN은 배선이나 주소를 전혀 변경하지 않고 논리적 토플로지를 변경할 수 있다는 매력적인 특징을 가지고 있다.

#### 이질성 문제
- 브리지는 제한된 유형의 네트워크만을 연결할 수 있다. 특히 브리지는 네트워크의 프레임 헤더를 이용하므로 같은 주소 형식을 사용하는 네트워크만을 지원할 수 있다.
- 브리지는 ATM과 같은 다른 종류의 네트워크를 지원하도록 일반화되어 있지는 않다.

#### 특징
- 제한에도 불구하고 브리지는 완전한 형태의 네트워크를 구축하는 데 중요한 역할을 담당한다.
- 다수의 LAN이 투명하게 연결된다는 점이다. 단말 호스트가 부가적인 프로토콜을 수행하지 않고도 네트워크가 연결될 수 있다는 뜻이다. 예외적인 경우는 호스트가 멀티캐스트 그룹의 가입자라는 사실을 외부에 알려야 한다는 점이다.
- 투명성이 위험할 수도 있다. 한 호스트에서 수행되고 있는 트랜스포트 프로토콜과 애플리케이션이 하나의 LAN에서 수행된다는 가정하에 작성되었다면, 발신지와 수신지 호스트 사이에 브리지를 설치하는 경우 브리지에 체증이 발생하면 브리지는 프레임을 제거하지만, 단일 이더넷이 프레임을 제거하는 경우는 없다는 점과 단일 이더넷에서는 소요시간은 작고 예측 가능한 반면, 확장 LAN에서는 두 호스트 간의 소요시간이 증가하고 변화폭도 커진다는 사실이 점, 마지막으로 단일 이더넷에서는 프레임의 순서가 바뀌는 일이 존재하지 않으나 확장 LAN에서는 발생될 가능성이 있다는 점들이 위험성을 부를 수 있다.