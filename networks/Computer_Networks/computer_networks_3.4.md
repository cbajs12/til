# 패킷 교환

## 구현 및 성능
- 간단한 교환기는 범용 워크스테이션에 몇개의 네트워크 인터페이스를 장착시키는 것이다. 이와 같은 장비는 패킷을 받을 수 있고, 스위칭 기능을 수행하고 인터페이스로 패킷을 보낼 수 있다.
- DMA의 방식의 워크스테이션의 경우 인터페이스에서 메모리로 직접 데이터를 이동하고, 패킷이 메모리에 들어오면 CPU는 헤더를 검사하여 어느 인터페이스로 패킷을 보내져야 할지를 결정한다. 그후 DMA를 이용하여 패킷을 해당 인터페이스로 이동시킨다. CPU는 헤더만 검사하지 패킷 전체를 읽지는 않는다.
- 워크스테이션을 교환기로 사용하는데 문제점은 모든 패킷이 하나의 경쟁 지점을 통과해야하기 때문에 성능에 제약이 생기는 것이다. (메모리, I/O 버스등) 또한, 패킷이 짧을때는 CPU가 헤더를 분석하는 비용이 더 클 경우도 생긴다.

### 포트
- 대부분 교환기는 개념적으로 여러개의 입력 및 출력 포트와 하나의 패브릭으로 구성된다.
- 패브릭을 통해서 포트와 통신하는 제어 프로세서가 일반적으로 하나 이상 존재하면서 교환기 전체를 관장한다.
- 포트는 교환기 바깥쪽과의 통신을 담당한다. 포트는 광섬유 수신기와 레이저 그리고 전송되기를 기다리는 패킷을 저장하는 버퍼로 구성되며, 대개 교환기를 동작하도록 해주는 많은 회로를 포함한다.
- 패브릭은 패킷이 주어지면 알맞은 출력으로 전달하는 임무를 수행한다.
- 포트의 임무 중 하나는 실제로 복잡한 것을 패브릭이 처리할 수 있는 상대적으로 간단한 것으로 만드는 것이다.
- 만약 교환기가 가상 회선 모델을 지원한다면, 가상 회선 매핑 테이블은 포트에 위치한다. 이 테이블은 각 VCI에 대해 패킷이 어느 출력으로 보내져야 하는 지와 그 VCI가 해당 출력 링크에서 유일성을 유지하며 어떻게 대치되어야 하는지에 대한 정보를 담고 있다.
- 이더넷 스위치의 포트는 이더넷 주소와 출력 포트 사이를 매핑하는 테이블을 보관한다.
- 일반적으로 입력 포트로부터 패브릭으로 넘겨질때, 포트는 패킷이 어느 곳으로 가야 하는 지를 알고 있으며, 이에 따라 포트가 패브릭을 설정하거나 패브릭이 자신의 임무를 수행하기에 충분한 정보(출력 포트 번호)를 패킷에 부착시킨다. 이러한 방식으로 동작하는 패브릭을 `자체 라우팅`이라 한다. 왜냐하면, 패킷을 라우팅하는 데 외부 제어를 요구하지 않기 때문이다.
- 성능 병목이 일어날 만한 첫번째 장소는 입력 포트이다. 입력 포트는 연속되는 패킷들을 수신하고, 각 헤더에 있는 정보를 분석하여 어떤 출력 포트로 보내야 하는 지를 결정하며, 패킷을 패브릭으로 전달하여야 한다. 헤더 분석 방법은 테이블 조회부터 많은 부분을 검사하는 복잡한 알고리즘까지 다양하게 존재한다.
- 포트의 다른 기능은 버퍼링이다. 버퍼링은 입력 또는 출력 포트에서 일어날 수 있다. 또 패브릭 내에서도 버퍼링이 발생할수 있는데 이것을 `내부 버퍼링`이라 한다.
- 간단한 입력 버퍼링은 심각한 제약을 가지고 있다. 그것은 `선두정지 현상`인데, 여러 입력 포트가 같은 출력 포트로 향할때 경쟁에서 밀린 포트의 패킷은 버퍼에 남는데 이것이 해당 버퍼 뒤의 패킷이 다른 출력 포트로 가는 것을 막는 행위를 말한다.
- 대다수의 교환기들은 순수한 출력 버퍼링이나 내부 및 출력 버퍼링의 혼합을 사용한다. 입력 버퍼링을 사용하는 교환기들은 선두정지를 피하는 버퍼 관리 기법을 사용한다.
- 버퍼는 교환기에서의 지연 시간이 발생하는 주요 원천이며, 저장할 공간이 부족해지면 패킷이 버려지는 곳이기도 하다. 따라서 버퍼는 교환기의 서비스 품질 특성이 결정되는 장소이다.

### 패브릭
- 교환기의 처리량 목표를 만족시키면서 최소 지연시간으로, 패킷을 입력 포트에서 출력 포트로 이동시킬수 있어야 한다. 이것은 대개 패브릭이 어느 정도의 병렬처리 기능을 가지고 있어야 한다는 것을 의미한다.

#### 패브릭 종류의 예
- 공유버스: 워크스테이션을 교환기로 사용하는 경우에서 볼 수 있는 패브릭, 버스의 대역폭이 교환기의 처리량을 결정하기 때문에, 대부분의 고성능 교환기는 PC에서 볼 수 있는 표준 버스보다는 특별히 설계된 버스를 가지고 있다.
- 공유 메모리: 패킷은 입력 포트에 의해 메모리에 쓰여지고 출력 포트에 의해 메모리로부터 읽혀진다. 교환기의 처리량을 결정하는 것은 메모리 대역폭이며, 이 종류의 설계에서는 폭이 넓고 빠른 메모리가 주로 사용된다. 
- 크로스바: 모든 입력 포트와 모든 출력포트를 연결하도록 구성될 수 있는 통로들의 행렬이다. 주요 문제는 각각의 출력 포트가 모든 입력 포트로부터 동시에 패킷을 받아들일 수 있어야 한다는 점이다. 이는 각 포트가 교환기 전체의 처리량에 해당하는 메모리 대역폭을 가져한다는 것을 의미한다.
- 자체 라우팅: 각각의 패킷을 알맞은 출력 포트를 향해 보내기 위해 패킷 헤더에 있는 정보에 의존한다. 입력 포트가 패킷이 어떤 출력 포트로 가야 하는지를 결정한후, 특별한 자체 라우팅 헤더를 패킷 앞에 부착시킨다. 이것의 설계로는 많은 수의 아주 간단한 2 X 2 스위칭 소자를 일정한 패턴으로 서로 연결하여 만들어지는 경우가 많다.

#### 자체 라우팅
- 2 X 2 스위치는 하나의 간단한 임무를 수행한다. 각 자체 라우팅 헤더의 한 비트를 보고 0이면 위쪽의 출력으로 1이면 아래쪽으로 패킷의 경로를 배정한다. 이 소자에 동시에 두 개의 패킷이 도착하고 양쪽 모두 같은 값으로 비트가 설정되어 있으면, 충돌이 발생한다. 이것을 방지하고 해결하는 것이 자체 라우팅 교환기 설계의 주요 문제이다.
- 자체 라우팅 헤더는 이진수로 인코딩된 출력 포트 번호를 포함하고 있다. 스위칭 소자의 첫번째 열은 자체 라우팅 헤더에 있는 출력 포트 번호의 최대 유효비트를 보고 0이면 위로, 1이면 아래로 라우팅한다. 두번째 스위칭 소자는 헤더의 두번째 비트를 보며, 마지막 열의 소자는 최소 유효 비트를 보고 라우팅을 한다.
- 충돌을 피하도록 스위치를 배열하는 것이 중요하다.
