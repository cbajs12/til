# 인터네트워킹

## 다중프로토콜 라벨 스위칭(MPLS)
- 데이터그램의 유연성과 견고성에 가장 회선의 특성을 결합하려는 것
- MPLS의 동작은 IP 라우팅과 주소에 기반하고 있다는 의미이다. 한편으로는 MPLS 가능 라우터는 상대적으로 짧고, 고정된 길이의 라벨에 따라 패킷을 전송하는데 이 라벨은 가상 회선 네트워크에서와 같이 지역적인 의미만을 가지고 있다.
- MPLS가 사용되고 있는 이유는 정상적인 방법으로 IP 데이터그램을 포워딩하는 기능을 갖지 못한 장비에 IP 기능이 가능하도록 하기 위한 것, IP 패킷을 미리 계산된 명시적인 경로, 즉 정상적인 IP 라우팅이 선택하지 않았을 수도 있는 경로로 전송하기 위한 것과 여러 유형의 가상 사설망 서비스를 지원하기 위해서이다.

### 목적지 기반 포워딩
- 라우터에 MPLS 기능이 수행되면 각 라우터는 라우팅 테이블의 각 프리픽스 마다 하나의 라벨을 할당하고, 라벨과 이 라벨이 의미하는 프리픽스를 인접 라우터로 전파한다. 이 전파를 `라벨 분배`라 한다. 라벨은 할당하는 라우터의 편의에 따라 선택되므로 이 라벨 값은 라우팅 테이블의 인덱스로 생각할 수도 있다. 라벨을 할당한 후, 라벨 결합을 인접 라우터로 전파한다. 이 전파의 의미는 특정 프리픽스로 향하는 패킷을 보낼때는 특정 라벨을 부착하여 달라는 것이다. 이것을 받은 라우터는 프리픽스와 라벨을 테이블에 저장한다. 이는 해당 프리픽스로 보내는 모든 패킷에 대한 출력 라벨로 표시된다.
- label edge router(LER)은 도착한 패킷들에 대하여 완전한 IP 주소 검색을 행하고 그 검색의 결과로 라벨을 패킷에 부착하는 동작을 수행한다.
- 라벨 포워딩 방식은 완전 일치 방식이다. 포워딩 알고리즘이 최장일치에서 완전일치로 변경되지만 라우팅 알고리즘은 일반적인 IP 라우팅 알고리즘을 사용할 수 있다. 이 환경에서 패킷이 전달되는 경로는 MPLS가 없을 때 전달 될 경로, 즉 IP 라우팅 알고리즘에서 선택되는 경로와 완전히 동일하다. 변화되는 것은 오직 포워딩 알고리즘일 뿐이다.
- 모든 MPLS 라벨은 Forwarding Equivalence Class(FEC)에 대응된다. FEC는 특정 라우터에서 동일한 방식으로 포워딩 처리되는 패킷들의 집합을 의미한다.
- IP 포워딩에서 라벨 스왑 방식으로 포워딩 알고리즘을 변경하면 IP 패킷을 포워딩하는 방식을 모르고 있던 장비들도 MPLS 네트워크에서는 IP 트래픽을 포워딩하는 데 사용가능하다는 것이다. ATM 스위치의 포워딩 하드웨어를 수정하지 않고도 MPLS를 지원할 수 있다.
- ATM 스위치는 라벨 스와핑과 포워딩 방식을 지원하고 있으며, IP 라우팅 프로토콜과 라벨 결합을 전파하는 방식을 제공함으로써 ATM 스위치는 label swithcing router(LSR)로 변화된다. LSR은 IP 제어 프로토콜을 수행하면서 라벨 스위칭 포워딩 알고리즘을 사용하는 장비를 말한다.
- 패킷에 라벨을 부착할때는 패킷이 전달되는 링크의 유형에 따라 부착 되는 곳이 달라진다. 대부분 유형의 링크에서 완전한 패킷의 형태로 IP이 전달되는 경우에는 라벨이 2계층과 IP 헤더 사이에 삽입된다. ATM 스위치가 MPLS LSR로 동작하는 경우에는 라벨은 스위치가 사용하고 있는 자리, 즉 셀 헤더에서 VCI와 VPI 항목이 있던 자리에 위치한다.
- ATM 네트워크 상에서 가상 회선으로 상호 연걸된 라우터들을 구성한 것을 `overlay`네트워크라 한다.
- overlay 네트워크에서 각 라우터는 다른 모든 라우터와 가상 회선을 통해 연결된다.
- 대규모 네트워크에서 스위치에 MPLS를 도입하면 각 라우터가 유지해야 하는 인접노드의 수는 획기적으로 줄어들게 되어 각 라우터가 다른 라우터로 구성의 변화를 통보해야 하는 작업의 양이 크게 줄어든다.
- 에지 라우터와 LSR에서 수행되는 라우팅 프로토콜이 동일할 경우 얻을 수 있는 이득은 에지 라우터가 전체적인 네트워크 구성에 관한 정보를 가진다는 점이다. 이는 네트워크 내부의 특정 링크나 노드에 장애가 발생할 경우 에지 라우터는 ATM 스위치가 에지 라우터에 대한 정보 없이 장애가 발생한 가상 회선을 재설정할 때 더욱 효과적으로 새로운 경로를 선택할 확률이 높아진다.
- ATM 스위치를 LSR로 대체한다는 것은 스위치에서 수행되는 프로토콜을 변경함으로써 가능해진다. 그러나 하드웨어를 교체하는 것은 아니라 소프트웨어 교체만으로 MPLS LSR로 변경될수 있다. 더구나 ATM LSR은 MPLS 제어 프로토콜을 수행하면서 동시에 표준 ATM 기능을 지원할 수도 있다.

### 명시적 라우팅
- MPLS는 IP 네트워크에 발신지 라우팅과 비슷한 기능을 추가하는 데 편리한 방법을 제공한다. MPLS에서는 이 방식을 발신지 라우팅이 아니라 명시적 라우팅이라 부른다. 이렇게 구분하는 이유는 일반적으로 경로를 선정하는 장소가 그 패킷의 발신지가 아니기 때문이다.
- MPLS는 패킷을 포워딩할 때 라벨을 사용하므로 라우터가 MPLS 가능한 장비라면 원하는 경로로 쉽게 라우팅을 실현할 수 있다.
- 네트워크 상의 모든 라우터들이 특정 라벨을 사용하고, 그 라벨에 따라 패킷을 포워딩하는 프로토콜을 `Resource Reservation Protocol(RSVP)`라 한다. RSVP 메시지를 지정된 경로로 전송하고 이를 통해 경로 상에 있는 모든 포워딩 테이블 엔트리를 설정하는 데 이용된다. 이 과정은 가상 회선 설정 과정과 유사하다.
- 명시적 라우팅의 응용 분야 중 하나는 트래픽 엔지니어링인데 이것은 네트워크에 주어진 요구사항을 만족할 수 있을 정도의 충분한 자원이 가용하도록 보장하는 작업이다.
- 명시적 라우팅은 신속한 경로 재설정 기능을 이용하여 장애 발생 상황에서도 네트워크의 안정성을 향상 시킬 수 있다. 
- 특정 경로를 따라 설정된 명시적 라우팅과 미리 계산된 대체 경로를 유지한다는 것은 라우터가 라우팅 프로토콜 패킷이 전체 네트워크로 확산되기를 기다리거나 네트워크 상의 다른 라우터들이 라우팅 알고리즘을 수행하기를 기다릴 필요가 없다는 것을 의미한다. 어떤 경우에는 이 방식이 장애가 발생한 지점을 우회하여 패킷을 전송하는 경로 재설정 시간을 획기적으로 줄여준다.
- 명시적 라우팅의 명시적 경로가 반드시 운영자에 의해 계산되어야 하는 것은 아니다 라우터에서 자동으로 명시적 경로를 계산하는 여러 알고리즘이 있다. 대표적인 알고리즘이 `constrained shortest path first(CSPF)`이다. 이것은 링크-상태 알고리즘과 유사하나 단지 제한조건도 감안한다는 차이가 있다.

### 가상 사설망과 터널
- MPLS도 터널을 구성하는 한 방안으로 생각할 수 있고 이는 MPLS를 이용하여 다양한 유형의 VPN을 구성할 수 있다는 것을 의미한다.
- MPLS VPN을 간단히 이해할수 있는 형태는 2계층 VPN이다. 이 유형의 VPN에서는 MPLS 가능 라우터로 구성된 네트워크를 통해 2계층 데이터를 전달하는 터널을 구성하는 데 MPLS를 이용한다.
- IP 라우터는 ATM 스위치가 아니다. 따라서 전통적인 라우터로 구성된 네트워크에서 ATM 가상 회선 서비스를 제공하는 것은 불가하다. 그러나 두개의 라우터 한 쌍을 터널로 연결하고 이 터널을 통해 ATM 셀을 전송하면 ATM 회선을 대행할 수 있다. 이런 기법을 IETE에서는 `가상 회선 대행`이라 한다.
- IP 터널은 터널의 입구에 있는 라우터가 터널을 통해 전달할 정보를 IP 헤더로 포장한다. 이 IP 헤더에는 터널의 반대쪽 라우터의 주소가 포함되어 다른 IP 패킷들과 같은 방식으로 전송된다. 수신 라우터는 헤더에 자신의 주소를 달고 온 패킷을 받으면 헤더를 뗴고, 터널을 통과한 데이터를 찾아 처리한다. 
- MPLS 터널도 이런 IP 터널과 크게 다르지 않는다. 다른 터널의 헤더가 IP 헤더가 아닌 MPLS헤더로 구성된다. 경로상의 각 라우터는 MPLS 라벨만을 조사하므로 이 경로로 패킷을 보내는 데는 다른 요구사항이 필요하지 않는다. 다만 어떤 데이터도 이 MPLS 헤더로 포장만 하면 같은 경로를 따라가게 된다. 이는 중간에 있는 라우터들은 MPLS 헤더를 넘어서는 검색하지 않기 때문이다.
- 터널을 통해 IP가 아닌 트래픽을 전송할 때의 한 가지 문제는 트래픽이 터널의 종점에 도달했을 때 IP가 아닌 트래픽을 어떻게 처리하는가이다. 일반적 해결책은 터널 페이로드에 역다중화 식별자와 같은 정보를 전송하여 터널의 종단에 있는 라우터에게 무엇을 할 것인지 알려주는 것이다. 이런 식별자로써 MPLS는 완벽하게 적용 가능하다.
- MPLS의 중요한 특징은 라벨은 제한 없이 패킷이 stack 될수 있다. 이는 확장 기능에서 매우 유용하다. 하나의 터널을 통해 많은 수의 가상 회선 트래픽을 전달할 수 있다.
- MPLS의 주요 장점은 보다 짧은 터널 헤더를 사용한다는 점이다.
- MPLS가 2계층 서비스를 터널링하는데 사용하기 전부터, MPLS는 3계층 VPN을 지원하는 데 사용되고 있었다. 이것은 현재 가장 광범위 하게 사용되고 있다.
- 3계층 VPN도 IP 네트워크를 통해 패킷을 터널링하기 위하여 MPLS 라벨 stack 기능을 이용한다. 그러나 터널을 통해 전달되는 패킷 자신들이 다시 IP 패킷이다. 3계층 VPN에서 하나의 서비스 제공자가 하나의 MPLS 가능 라우터로 구성된 네트워크를 운영하여 임의 수의 가상 사설 IP 네트워크를 서로 다른 고객에게 제공할 수있다. 
- 즉, 사업자에서 일정한 수의 사이트를 가진 각 고객에게 그 네트워크에는 다른 고객이 연결되어 있지 않은 것 같은 환상을 제공한다는 것이다. 그 고객은 자신의 사이트 만을 연결하는 IP 네트워크만을 볼수 있다. 이것은 각 고객들이 다른 고객들로부터 라우팅이나 주소 체계의 관점에서 분리되어 있다는 의미이다.
- 고객 A는 고객 B로 혹은 그 반대로 패킷을 직접 보낼수 없다. 고객 A는 심지어 고객 B가 사용하고 있는 IP 주소를 사용할 수도 있다.
- 2계층 VPN과 같이 MPLS는 한 사이트에서 다른 사이트로 패킷을 터널링하는 데 사용도니다. 그러나 터널의 구성은 BGP를 정교하게 사용하여 자동으로 수행된다.
- MPLS는 가상 회선 네트워크에서 일반적으로 사용되는 라벨 스와핑 포워딩 기법과 데이터그램에서 사용되는 라우팅 및 제어 프로토콜을 결합하여 극단적인 두 기법 사이에서 계층적인 네트워크를 실현한 것이다. 
