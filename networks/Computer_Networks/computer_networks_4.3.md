# 인터네트워킹

## 전역 인터넷
- 상호 연관된 두 가지의 확정성 문제를 다룰 필요가 있다. 하나는 라우팅의 확장성이다. 라우팅 프로토콜에서 주위로 전달되고 라우터의 라우팅 테이블에 저장될 네트워크 번호의 수를 최소화하는 방법을 찾을 필요가 있다. 두번째는 주소 활용도이다. 즉, IP 주소 공간이 너무 빨리 소비되지 않게 하는 것이다.

### 서브네팅
- IP 주소의 본래 목적은 IP 주소의 네트워크 부분이 하나의 물리적 네트워크를 유일하게 식별하도록 하는 데 있다. 그러나 이러한 접근 방식은 두가지 단점이 있다. 
- 하나는 IP 주소의 할당의 비효율성이다. 단 두 개의 노드를 가진 네트워크라도 클래스 C를 사용해야 하므로 결과적으로 253개의 주소를 낭비하게 되며, 또한 255개의 호스트를 약간 넘는 네트워크가 클래스 B를 사용한다면 약 64,000개의 주소를 낭비하는 결과가 된다. 그러므로 물리적 네트워크마다 하나의 네트워크 번호를 할당한다면 빠르게 주소가 소모된다.
- 라우팅 관점에서의 단점은 라우팅 프로토콜에 참여하는 한 노드에 저장되어 있는 상태 정보의 양은 다른 노드의 수에 비례하며, 사용 중인 네트워크 번호가 많으면 많을수록 포워딩 테이블은 커지게 된다. 큰 테이블은 라우터에 부담을 주게 되고 테이블 검색 성능이 느려질 수도 있다.
- 서브네팅은 할당된 네트워크 번호의 수를 줄이는 단순한 방법이다. 이 방법은 하나의 네트워크를 사용하여 그 네트워크 번호의 IP 주소를 여러 개의 물리적 네트워크에 할당하는 것으로 `서브넷`이라고 한다.
- 서브넷을 사용하기 위해서는 서로 가까운 거리에 있어야 한다. 이것은 인터넷 상의 다른 지점에서 볼때 같은 네트워크 번호를 사용하는 하나의 네트워크처럼 보인다. 이는 한 라우터가 이들중 어느 서브넷에 도달할 수 있는 하나의 경로를 선택할 수 있음을 의미한다. 즉, 모든 서브넷이 동일한 방향에 존재하는 것이 바람직하다.
- 서브네팅을 사용하는 가장 좋은 환경은 많은 물리적 네트워크를 갖고 있는 조직체이다. 조직체 외부에서 조직체 내부의 임의의 서브넷에 가기 위해 알야하 할 것은 조직체가 인터넷의 어디에 연결되어 있는가이다. 그 곳이 하나의 지점이라면 포워딩 테이블에서 하나의 항목으로 충분히 나타낼수 있다. 그 조직체가 인터넷의 여러 지점으로 연결되어 있어도 그 조직체 네트워크의 한 지점만 알면 여전히 원하는 서브넷을 찾을 수 있다.
- 여러 개의 네트워크가 하나의 네트워크 번호를 공유하기 위하여 각 서브넷 상의 모든 노드는 같은 `서브넷 마스크`로 구성되어야 한다. 단순한 IP 주소 방식에서는 같은 네트워크 내에 있는 모든 호스트는 같은 네트워크 번호를 가져야한다. 그러나 서브넷은 `서브넷 번호`를 사용하는데, 같은 물리적 네트워크에 있는 모든 호스트는 동일한 서브넷 번호를 갖게된다. 이는 같은 네트워크 번호를 사용하는 호스트가 다른 물리적 네트워크 위에 있을 수 있다는 것을 의미한다.
- 서브넷 마스크는 IP 주소를 또 다른 수준으로 계층화시킨다. 서브넷 마스크는 IP 주소와 같은 방식으로 표현된다. 예로 클래스 B를 사용한다면, 서브넷 마스크는 상위 24비트를 네트워크 번호로 정의하고, 하위 8비트는 호스트 번호로 정의한다. IP에서는 상위 16비트는 클래스 B에서 네트워크를 구별하는 데 사용되므로 결국 주소는 두부분이 아니라 네트워크, 서브넷, 호스트의 세부분으로 나뉘는 것이다. 즉 호스트 부분을 서브넷 부분과 호스트 부분으로 사용하도록 나누는 것이다.
- 호스트에서 서브네팅이란 그 호스트가 IP 주소와 자신이 접속된 서브넷의 서브넷 마스크로 구성되어야 한다는 것을 의미한다. 한 서브넷 상의 모든 호스트는 같은 마스크로 구성된다. 즉, 각 서브넷마다 하나의 서브넷 마스크가 존재한다. IP 주소와 서브넷 마스크의 비트별 AND 연산으로 그 호스트와 같은 서브넷 상에 접속된 다른 모든 호스트의 서브넷 번호가 계산된다. 호스트가 어떤 IP로 패킷을 보낼 때 첫번째 해야 할 일은 자신의 서브넷 마스크와 목적지 IP 주소를 비트별 AND 연산하는 것이다. 그 결과가 송신 호스트의 서브넷 번호와 같으면 그 목적지 호스트가 같은 서브넷 상에 있다는 것을 알게되고 그 서브넷으로 직접 패킷을 포워딩한다. 만약 다르다면, 패킷을 다른 서브넷으로 포워딩하기 위하여 라우터로 보내져야 한다.
- ARP는 이와 같은 주소 구조의 변화에 영향을 받지 않는다. 일단 호스트나 라우터가 자신에게 접속된 네트워크 중 하나로 패킷을 전달하기 위하여 어느 노드로 전송해야 하는지를 알아낸 후, 필요하다면 그 노드의 MAC 주소를 발견하기 위해 ARP를 수행한다.
- 서브넷 방식을 도입하면 라우터의 역할도 변한다. 라우터는 `<SubnetNum, SubnetMask, NextHop>` 형식의 테이블을 가지게 되는 것으로 변화한다. 이 테이블에서 맞는 엔트리를 발견하기 위해 라우터는 패킷의 목적지 주소와 각 엔트리에 대한 subnet mask를 가지고 차례로 비트별 AND 연산을 한다. 그 결과가 항목의 서브넷 번호와 일치하면 패킷을 그 항목이 가리키고 있는 다음 홉으로 넘겨준다.
- 서브네팅이 확장성 문제를 해결하는 방식은 새로운 물리적 네트워크가 생성될 때마다 매번 클래스 C/B의 주소 전부를 사용하지 않도록 함으로써 주소 할당의 효율성을 개선한다. 또한, 정보릐 통합인데 일정한 거리에서 보면 여러 물리적 네트워크는 하나의 네트워크처럼 보이게 할수 있다. 이것으로 데이터를 포워딩하기 위해 라우터가 저장해야할 정보가 감소될 수 있다.

### 무계급 라우팅
- 자율 시스템(AS): 각각의 제공자 네트워크를 뜻하며, 각 제공자 네트워크는 그들의 네트워크에서 사용하는 최상위 라우팅 프로토콜과 네트워크 내의 각 링크에 메트릭을 할당하는 방식에 대하여 서로 다른 방법을 가질수 있다.
- 무계급 도메인 간 라우팅(CIDR)는 주소를 효율적으로 분배해야 하는 요구조건과 라우터가 알아야 하는 라우팅 정보의 양을 최소화하려는 요구조건을 충족시키려는 시도를 한다. 그러기 위해 CIDR은 경로를 집단화할 수 있도록 해준다. 즉, 포워딩 테이블 내에 하나의 엔트리만을 사용하여 서로 다른 여러 네트워크에 도달하는 방법을 표시할 수 있도록 한다. CIDR는 주소 클래스 간의 고정된 경계를 없앰으로써 이 문제를 해결하였다.
- 어떤 AS가 16개의 클래스 C 네트워크 번호를 갖는다고 하면, 16개의 주소를 임의로 분배하는 대신에 연속적인 클래스 C 네트워크 번호로된 블록으로 분배한다. 즉, 한번에 256 노드의 단위로 주소를 분배하는 효율성과 포워딩 테이블에서 사용될 단일 네트워크 프리픽스를 가능하게 하고 있다. 이 방안이 수행되기 위해서는 공통의 네트워크 번호를 공유하는 클래스 C 주소를 블록 단위로 분배해야 하며, 각가의 블록은 2의 승수 개의 클래스 C 네트워크를 포함해야 한다.
- CIDR에서는 프리픽스가 임의의 길이가 될수 있으므로 네트워크 번호나 알려진 프리픽스를 표현하는 새로운 유형의 표기법이 필요하다. 이 표기법은 프리픽스 뒤에 `/X`를 부가하는 것이다. 여기서 X는 프리픽스의 비트 단위 길이를 의미한다. CIDR이 일반화되는 요즘에는 C 클래스 네트워크라는 말보다 `/24`라는 용어를 더욱 흔히 이야기한다.
- CIDR가 문제를 해결하기 위해서는 무계급 주소(네트워크 번호가 임의의 길이로 구성될 수 있는 주소)를 다룰수 있는 라우팅 프로토콜이 필요하다. BGP-4와 같은 라우팅 프로토콜이 그것이다. 이러한 라우팅 프로토콜에 의하여 전달되는 네트워크 번호는 간단히 `<length, value>` 쌍으로 표현된다. length는 네트워크 번호의 비트 수를 뜻한다. 이 방식에서 네트워크 주소를 표현하는 기법은 서브네팅에서의 `<mask, value>` 표기법에서 mask가 MSB로부터 시작되는 연속적인 비트로 구성되는 경우 서브네팅 기법과 유사하다. 또한, 서브네팅은 여러 개의 물리적 네트워크가 같은 네트워크 주소를 공유하기 위해 사용하는 데 반해, CIDR는 하나의 AS에 할당된 다중 주소를 하나의 주소처럼 처리하는 것을 목표로 하고 있다.
- 동일 사업자 네트워크에 연결된 서로 다른 고객 네트워크에 더 짧고 공유 가능한 프리픽스를 할당하는 방식으로 고객의 네트워크 프리픽스를 할당한다면 보다 많은 경로를 통합할 수 있을 것이다.

#### IP 포워딩에 대한 재고
- CIDR는 2~32비트까지 어떤 길이의 프리픽스도 될수 있다. 또한, 때로는 포워딩 테이블이 하나 이상의 중첩된 프리픽스들을 가질 수 있다. 여기서 중첩되었다는 것은 같은 주소가 여러 프리픽스들과 일치될 수 있음을 의미한다. 이럴때에는 `최장일치` 원칙을 따르는데 패킷은 가장 긴 프리픽스에 일치된다.

### 도메인 간 라우팅
- AS의 기본적인 개념은 확장성을 향상시키기 위하여 거대한 인터넷에서의 라우팅 정보를 계층적으로 모으는 방법을 제공하는 것이다. 여기서 라우팅은 AS 내부 라우팅과 AS 사이의 라우팅으로 나뉜다. 인터넷에서 AS라는 것은 `라우팅 도메인`을 나타내기 때문에 라우팅 두 부분을 내부 도메인 라우팅과 도메인 간 라우팅이라고 한다.
- 확장성에 부가적으로 AS 모델은 한 AS 내에서 운영되는 내부 도메인 라우팅과 다른 AS에서 운영되는 내부 도메인 라우팅을 분리할 수 있도록 한다. 따라서 각 AS는 AS에서 선택한 어떤 내부 도메인 라우팅 기법이라도 사용할 수 있다. 또한, 정적인 라우팅이나 다중 프로토콜도 필요하다면 사용할 수 있다. 도메인간 라우팅은  서로 다른 AS 간에 도달 가능 정보를 공유하도록 하는 것이다. 도달 가능 정보란 주어진 AS를 통해 도달할수 있는 IP주소집합에 대한 정보를 의미한다.
- 도메인 간 라우팅에서 가장 중요한 문제는 각 AS가 자신의 라우팅 정책을 결정하는 문제이다. 접속하고 있는 AS의 수가 많아질수록 정책은 더욱 복잡해질 것이다. 즉, 도메인 간 라우팅의 주요 목표는 복잡한 기능이 도메인 간 라우팅 시스템에 의하여 지원되어야 한다는 것이다. 더욱 어려운 문제는 이런 정책들이 다른 AS의 도움 없이 구현되어야 하며, 다른 AS의 비정상 동작이나 잘못된 설정에도 대비해야 한다는 것이다.
- 인터넷의 역사에는 두가지의 도메인 간 라우팅 프로토콜이 있다. 하나는 EGP이다. EGP는 많은 제한점을 가지고 있으나, 가장 심각한 부분은 인터넷의 토폴로지를 제한한다는 것이다. 기본적으로 EGP는 인터넷이 트리와 유사한 토폴로지를 가질것을 요구한다.
- EGP를 대체하기 위한 것으로 BGP가 있는데 상당히 복잡하다. BGP는 인터넷을 임의로 연결된 AS의 집합이라고 가정한다. 이것의 모델은 다중 백본망으로 되어있어 오늘날의 인터넷이 이러한 백본망(서비스 제공자 네트워크라고도 하고 주로 사기업에서 운영한다)간에 상호 연결된 방식으로 구성되며, 각 사이트는 임의의 방식으로 각 백본망에 연결되어 있다.
- AS내의 노드에서 시작되거나 끝나는 트래픽을 지역 트래픽으로 정의하고, AS를 통과하는 트래픽을 전이 트래픽으로 정의한다. 또한, AS는 3가지 타입으로 구분할수 있다.
- 스텁 AS: AS 중에서 다른 하나의 AS에만 연결된 것을 말한다. 이러한 AS는 지역 트래픽만을 전달한다. 작은 기업 수준과 같다.
- 다중 연결 AS: 하나 이상의 다른 AS에 연결하고 있으나 전이 트래픽을 취급하지 않는 AS를 말한다. 큰 기업 수준과 같다.
- 전이 AS: 하나 이상의 다른 AS에 연결되어 있으며, 전이 트래픽과 지역 트래픽을 모두 전달하도록 설계되어 있는 시스템으로 기간망 서비스 제공자와 같다.
- 도메인 간 라우팅 문제는 확장성 문제를 최적 경로와 함께 고려해야한다. 가고자 하는 목적지에 대한 루프가 없는 경로를 찾는 일과 경로는 그것이 경유하는 모든 AS의 정책과 일치해야 하는 점을 모두 고려하여 설계되어야 한다.
- 도메인 간 라우팅이 어려운 이유 중 하나는 규모가 큰 것인데, 인터넷 기간망 라우터는 인터넷에서 어떤 곳으로 향하는 패킷이라도 포워딩할 수 있어야 한다. 즉, 어떠한 IP라도 일치할 수 있는 테이블을 가져야 한다는 것이다. 두 번째는 각각의 도메인은 자신의 내부적인 라우팅 프로토콜을 운영하고 경로에 대한 메트릭을 할당하기 위해 자신들만의 구조를 사용할 수 있다. 이것은 여러 AS들을 통과하는 경로에 대한 의미 있는 경로 비용을 계산하기가 불가하다는 것이다. 결과적으로 도메인 간 라우팅은 단지 도달가능성 정보만을 알려준다. 즉, 도메인 간 라우팅에서 최적 경로를 선택하는 것이 본질적으로 불가능하다는 것이다. 마지막은 신뢰성 문제이다. 각 서비스 제공자가 보내는 정보를 신뢰할수 없을 수도 있다는 것이다.
- BGP를 구성할 때, 각 AS의 관리자는 적어도 하나의 노드를 전체 AS의 대변인 기능을 담당하는 BGP 대화자로 선정한다. 그 대화자는 다른 AS에 있는 BGP 대화자와 BGP 세션을 설정한다. 이러한 세션들은 AS 간에 도달가능 정보를 상호 교환 하는데 사용한다.
- BGP 대화자뿐 아니라 AS는 하나 이상의 변방 게이트웨이를 가지고 있는데 이것이 반드시 BGP 대화자와 같을 필요는 없다. 변방 게이트웨이란 그 AS로 도달하는 패킷이 거치게 되는 라우터이다. 도메인간 라우팅 관점에서 볼때, 변방 게이트웨이는 AS 사이에서 패킷을 전송하는 역할을 담당하는 IP 라우터라는 것이다.
- BGP는 거리 벡터와 링크 상태 프로토콜 중 어떤 부류에도 속하지 않는다. 이런 프로토콜과는 달리 BGP는 특정 네트워크에 도달하기 위하여 경유해야 하는 AS들을 순서대로 나열한 목록으로 표현되는 완전한 경로를 알려준다. 이것은 특정 AS의 희망에 따라 여러 정책 결정이 이루어지도록 하기 위해 필요하고, 라우팅 루프가 쉽게 검출될 수 있도록 한다.
- BGP의 중요한 작업은 루프 경로가 설정되는 것을 방지하는 일이다. 루프가 있을 경우 라우팅 메시지 안에서 완전한 AS 경로를 전달함으로써 방지될 수 있다. 또한, BGP에서 전달되는 AS 번호는 유일해야 한다. AS 번호는 16비트의 숫자로써 유일성을 보장하기 위하여 중앙 기관에서 부여한다. 스텁 AS에서는 유일한 AS 번호가 필요하지 않는다.
- BGP 대화자는 경로를 브로드캐스팅하는 것뿐 아니라, 어떤 링크가 경로가 단절되었을 경우 이전에 알렸던 경로를 취소할 수도 있다. 이것은 `경로 철회`로 알려진 부정 알림의 형태로 이루어진다.
- BGP-4에 대해 명심할 것은 무계급 주소를 처리하기 위해 설계되었다는 것이다. 이것은 BGP에서 알려진 네트워크가 실질적으로 어떠한 길이의 프리픽스도 가질수 있다는 것을 의미한다. 따라서 갱신 메시지는 프리픽스와 비트 단위의 길이 모두를 포함하고 있다. 그것은 보통 `프리픽스/길이`로서 표현된다.
- BGP는 신뢰성 있는 전달 프로토콜인 TCP위에서 수행된다는 점이다. BGP 대화자는 TCP가 신뢰성이 있다는 것에 기반을 두고 있으므로 한 대화자로부터 다른 대화자로 전송된 정보는 다시 전송될 필요가 없다는 것을 의미한다. 그러므로 상황이 변하지 않았다면 BGP 대화자는 주기적으로 keepalive 메시지만을 단순히 전달하면 된다.
- BGP 대화자는 상호 메시지 교환을 통해 충분한 정보를 유지하고 있으므로, 도달 가능한 모든 네트워크에 대해 루프없는 경로를 계산할 수 있다. 그러나 최선의 경로를 찾는 방법은 AS 정책에 의존한다.

#### 도메인 간 라우팅과 도메인 내부 라우팅의 통합
- 일반적으로 도메인 안에서 모든 다른 라우터들이 도메인 간 라우팅 정보를 얻는가에 대한 문제는 한 지점에서만 다른 AS로 연결되어 있는 스텁 AS인 경우, 변방 라우터는 AS 외부에 존재하는 모든 라우터로 가기 위한 유일한 선택이 된다. 이러한 라우터는 내부 도메인 라우팅 프로토콜로 디폴트 경로를 밀어넣을 수 있다. 사실상 이것은 내부 도메인 프로토콜을 통하여 명확하게 알려지지 않은 모든 네트워크들이 이 변방 라우터를 통하여 도달할 수 있다고 선언하는 것이다.
- 이보다 복잡한 과정은 외부 AS로부터 알게 된 특정 경로들을 변방 라우터에 밀어 넣어야 하는 경우이다. 더욱 복잡한 경우는 백본망에서 나타난다. BGP로부터 매우 많은 라우팅 정보를 알게 되어 그 정보를 모두 내부 도메인 프로토콜에 밀어 넣는 것은 너무 많은 비용이 드는 일이다. 이런 이유로 기간망의 라우터들은 AS의 에지에서 BGP 대화자에 의해 알게 된 정보를 AS안의 모든 다른 라우터들에게 효과적으로 재분배하기 위해 내부 BGP(iBGP)라 불리는 변형된 BGP를 사용한다.
- iBGP는 AS안의 모든 라우터들이 특정 주소로 패킷을 보낼 때 어떤 변방 라우터를 통해 보내는 것이 가장 좋은지를 알수 있도록 해준다. 동시에 AS안에 있는 각각의 라우터는 새로이 삽입되는 정보 없이, 기존의 내부 도메인 프로토콜을 사용하여 변방 라우터에 도달하는 방법을 이미 알고 있다. 이러한 두 가지 종류의 정보를 조합하여, AS안의 각 라우터는 모든 프리픽스에 대해 적절한 다음 홉을 결정할 수 있다.
- AS 내의 모든 라우터들은 RIP나 OSPF와 같은 특정 도메인 내부 라우팅 프로토콜을 수행하고 있다.(도메인 내부 라우팅 프로토콜의 일반적인 용어가 바로 IGP이다.) 이와 같은 완전히 분리된 프로토콜에 의해 라우터는 도메인 내의 다른 노드에 도달하는 방식을 학습한다. 내부 라우터는 iBGP를 통하여 학습한 외부 프리픽스와 IGP를 통하여 학습한 변방 라우터로 가는 내부 경로 정보를 조합하여 완전한 시야를 확보하게 된다. 이러한 방식으로 AS 내의 모든 라우터는 그 AS의 변방 라우터를 통하여 도달가능한 모든 프리픽스에 대한 완전한 라우팅 테이블을 구성할 수 있다.

### 라우팅 지역
- 충분한 계층 구조를 가지고 있지 않은 경우 링크-상태 내부 도메인 라우팅, 특히 OSPF는 라우팅 도메인을 `지역`이라고 불리는 서브 도메인으로 분할하는 방법을 제공한다. 계층 구조에 추가적인 단계를 더함으로써, 내부 도메인 라우팅 프로토콜에 과중한 짐을 지우지 않으면서도 하나의 도메인을 더욱 크게 확장할 수 있다.
- 지역은 서로 간에 링크-상태 정보를 교환하기 위해 구성된 라우터의 집합이다. 여기에 지역 0으로 알려진 기간망 지역이 존재한다. 기간망 지역과 기간망이 아닌 지역 모두에 동시에 속해 있는 라우터는 지역 변방 라우터(ABR)이다. 이러한 것들은 AS의 에지에 있는 라우터들과는 서로 구별되며, 이 에지 라우터는 명확하게 AS 변방 라우터라고 불린다.
- 지역 안의 모든 라우터들은 서로에게 링크-상태 정보를 브로드캐스팅하고, 이를 이용하여 완전하고 일관된 지역 맵을 그리게 된다. 그러나 지역 변방 라우터가 아닌 라우터의 링크 상태 정보는 그들이 발생된 지역을 벗어나지 않는다. 이런 이유로 플러딩과 경로 계산 과정의 확장성이 상당히 개선된다.
- 하나의 지역 안의 라우터가 다른 지역의 네트워크로 향하는 패킷을 위한 정확한 다음 홉을 결정하는 방법은 하나의 백본망이 아닌 지역에서 다른 지역으로 향하는 패킷의 경로를 세부분으로 나누어 보면 알수 있다. 우선 패킷은 발신지 네트워크에서 백본망 지역으로 전달되고, 백본망을 경유하여, 백본망에서 목적지 네트워크로 향한다. 이 과정이 잘 동작되게 하기위하여, 지역 변방 라우터들은 한 지역으로부터 알게 된 라우팅 정보를 요약하여 다른 지역에 알려줌으로써 이 정보를 이용할 수 있도록 한다.
- 지역에 두 개의 ABR이 존재할 경우 그 지역의 라우터들은 백본망에 도달하기 위해 어떤 것을 사용할지 선택해야 한다. 그러나 각각의 변방 라우터들이 서로의 비용을 브로드캐스팅하므로 쉽게 선택할 수 있다.
- 도메인을 지역으로 나눌 때, 네트워크 관리자는 확장성과 라우팅의 최적성 사이에서 형평성을 고려한다. 지역을 사용하면 최단 경로하는데도, 한 지역에서 다른 지역으로 향하는 모든 패킷들이 백본망 지역을 경유하다록 강요한다는 의미이다.
- 네트워크 관리자가 어떤 라우터를 지역 0으로 보낼 것인가를 보다 유연하게 결정할 수 있는 기법이 존재하는데 이것은 `가상 연결`이라는 것이다. 가상 연결은 지역 0과 직접 연결되지 않은 라우터와 백본망에 있는 라우터 간에 백본망 라우팅 정보를 교환하도록 구성하는 경우에 설정된다. 이렇게 선택된 라우터는 기간망의 일부분이 되어 다른 지역 0의 라우터와 같이 링크 상태 정보의 플러딩에 참여하게 된다. 이 기술은 라우팅의 최적성을 향상시키는데 도움이 된다.
- 네트워크 설계에서 최적성과 확장성 사이에는 선택의 문제가 존재한다. 계층구조가 도입되는 경우, 정보는 네트워크의 일부 노드로부터 숨겨지게 되므로 완전히 최적인 결정을 하지 못하게 된다. 그러나 일부 정보를 숨기는 것이 모든 노드들로 하여금 전체적인 지식을 가질 수 있도록 하므로, 확장성에 있어서 정보의 숨김은 본질적인 것이다.

### IP 버전 6
- 32비트 주소에 의해 제공되는 것보다 더 큰 주소 공간을 위해서 논의되기 시작하였다.

#### 주소와 라우팅
- 128비트 주소 공간을 가진다. 100% 효율성을 가정하면, 3.4 * 1038개의 노드를  지정할 수 있다.

#### 주소 공간 할당
- IPv6 주소도 클래스를 갖지 않는다. 그러나 주소 공간은 선행 비트들에 따라 다양한 방식으로 나뉜다. 이 선행 비트들은 서로 다른 주소 클래스를 지정하는 것이 아니라 IPv6 주소의 용도를 지정한다.
- IPv4의 클래스 A, B, C는 `나머지` 에 속한다. 이것은 전역 유니캐스트 주소는 길이가 아주 길다는 점을 제외하면 대부분 무계급 IPv4 주소와 유사하다.
- 멀티캐스트 주소 공간은 모두 1로 구성된 한 바이트로 시작되므로 쉽게 구분할 수 있다.
- 링크 지역 사용 주소는 호스트가 전역적으로 유일한지를 고려하지 않고 자신이 접속되어 있는 네트워크에서만 유일하도록 만드는 데 목적이 있다. 사이트 지역 사용 주소는 인터넷에 접속되지 않은 사이트에 유효한 주소를 허용하자는 데 의도가 있다. 이런 환경에서는 전역적 유일성은 문제가 되지 않는다.
- 확보된 주소 공간 중 첫 번째 바이트가 모두 0으로 시작되는 주소는 중요한 의미를 지닌 특수한 주소이다. 한 노드는 `IPv4-호환 IPv6`를 할당받을 수 있는다. 이 주소는 32비트 IPv4 주소에 0을 삽입하여 128비트로 확장하여 만든다. IPv4 주소만을 이해할 수 있는 노드에는 32비트 IPv4 주소의 앞부분에 1로된 2바이트와 0으로 된 나머지 바이트를 첨가하여 128비트로 만든 `IPv4-대응 IPv6` 주소를 할당한다.

#### 주소 표시법
- 표준 표기법은 `x:x:x:x:x:x:x:x`이다. 각 x는 그 주소의 16비트에 대한 16진수 표현이다.
- IPv6 중에는 몇몇 특별한 형태가 있는데, 예로 연속적으로 0을 갖는 큰 주소의 주소는 모든 0필드를 생략함으로써 더 간단히 사용할 수 있다. 이러한 단축형은 모호함을 피하기 위해 주소에서 연속적인 0의 집합에서만 사용할 수 있다.

#### 전역 유니캐스트 주소
- IPv6을 채택할 때 가장 중요한 것은 기존의 유니캐스트 주소에 대한 문제이다. 우선 인터넷에 새로운 호스트를 신속히 첨가할 수 있어야 하며, 인터넷에서 물리적 네트워크의 수가 증가함에 따라 확장이 가능한 라우팅을 허용해야 한다. 결과적으로 IPv6의 핵심은 어떻게 001 프리픽스로 표현되는 제공자 기반 주소가 서비스 제공자, 자율 시스템, 네트워크, 호스트 그리고 라우터에 할당될 것인지를 결정하는 유니캐스트 주소 할당 계획이라고 할 수 있다.
- 가입자를 `비전이 AS`라고 하고 제공자를 `전이 AS`라고 하자. 제공자는 가입자에게 직접 접속된 것으로 `지역망`과 가입자에게 직접 접속된 것이 아니라 주로 제공자를 연결해 주는 역할을 담당하므로 일반적으로 `백본망`이라 하는 것으로 나뉜다.
- IPv6 주소 할당 계획의 목표는 도메인 내에 있는 라우터의 부담을 줄이기 위해서 라우팅 정보의 통합을 제공하는 것이다. 즉, 핵심적인 생각은 주소의 최상위에 위치한 연속적인 비트의 집합인 주소의 프리픽스를 이용하여 많은 수의 네트워크와 많은 수의 AS의 도달 정보를 통합하자는 것이다. 
- 이러한 목표를 달성하기 위한 중요한 방법은 직접 제공자에게 하나의 주소 프리픽스를 할당하고, 그 직접 제공자가 그 프리픽스로 시작하는 더 긴 길이의 프리픽스를 가입자에게 할당하도록 하는 것이다. 결과적으로 한 제공자는 자신의 모든 가입제에게 같은 프리픽스를 통보한다. 이러한 동작을 `제공자 기반 주소 체계`라고 한다. 이러한 방식에 의해 한 사이트에 할당된 모든 IPv6 주소는 그 사이트에 대한 제공자를 지정하는 동일한 프리픽스를 포함하고 있다. 한 사이트가 제공자를 변경하고자 한다면, 새로운 주소 프리픽스를 얻어야 하고, 그 사이트에 있는 모든 노드에게 다시 번호를 매겨야 하는 단점이 있다.
- RegisryID는 서로 다른 ID가 서로 다른 대륙과 나라에 할당되는 것처럼 유럽의 주소 등록 기관에 할당된 식별자이다.

#### IPv4로부터 IPv6로의 전이
- IPv4만 처리할 수 있는 호스트와 라우터가 가능한 한 계속 운용되도록 하면서 IPv6을 점진적으로 배치할 필요가 있다. 이상적으로는 IPv4 노드는 IPv4와 IPv6 능력을 가진 일부 노드와도 통신할 수 있어야 한다. IPv6 호스트는 그들 사이의 하부 구조가 단지 IPv4만 제공하는 경우라도 다른 IPv6 노드와 대화가 가능해야 한다. 이러한 전이를 돕기 위하여 `이중 스택 운용`과 `터널링`이라는 기법이 정의되었다.
- 이중 스택 방안은 IPv6 노드는 IPv6와 IPv4 모두를 수행하고 version 필드를 사용하여 도착한 패킷을 어떤 스택이 처리해야 하는지를 결정한다. 이러한 경우에 IPv6 주소는 IPv4 주소와 무관한 주소이거나, IPv4-대응 IPv6 주소일것이다.
- 터널링 기술은 IP 패킷이 다른 IP 패킷의 페이로드로 전송되는데 사용된다. IPv6 전이에서의 터널링은 IPv4만을 이해할 수 있는 네트워크의 일부분을 통하여 IPv6 패킷을 전송하기 위해 사용된다. IPv6 패킷을 IPv4 패킷 내에 포장한다는 의미이다.

#### 패킷 형식
- Version 필드로 시작되며, IPv6에서는 6으로 정해졌다. Version 필드의 헤더 시작 위치로부터의 상대적인 위치는 IPv4의 Version 필드에서와 같게 함으로써 헤더를 처리하는 소프트웨어가 어떤 헤더 형식으로 해석할 것인지를 즉각 결정할 수 있도록 하였다.
- TrafficClass와 FlowLabel 필드는 서비스 품질에 관련된 필드이다.
- PayloadLen 필드는 IPv6 헤더를 제외한 패킷 길이를 바이트 단위로 나타낸다. 
- NextHeader 필드는 IP의 옵션과 IPv4의 Protocol 필드를 명석한 방식으로 대체하였다. 옵션이 필요한 경우, IP 헤더 뒤에 이어지는 하나 이상의 특별 헤더에 이것을 포한하고 이를 NextHeader 필드 값으로 포인팅 한다. 특별 헤더가 없으면, NextHeader 필드는 IP 위에서 수행되는 상위 단계 프로토콜에 대한 값을 나타낸다. 이 경우 IPv4의 Porotocol 필드와 같은 목적으로 사용된다. 또한 단편화도 이제 옵션 헤더로 다루어지므로 Ipv4의 단편화와 관련된 필드는 IPv6 헤더에는 포함되지 않는다는 것을 의미한다.
- HopLimit 필드는 단순히 IPv4의 TTL이지만, 그것의 실제적인 사용 방법을 반영하기 위해 이름을 바꾼것이다.
- 헤더의 나머지는 발신지와 목적지 주소가 차지하고, 각각의 128비트 길이이다. 결과적으로 IPv6 헤더는 항상 40바이트 길이를 유지한다.
- IPv6는 IPv4보다 개선된 방식으로 옵션을 처리한다. IPv4에서 옵션이 존재하는 경우 모든 라우터는 옵션 중에 어떤 것이 관계되는지를 조사하기 위해 전체 옵션 필드를 모두 분석해야 한다. 이러한 이유는 옵션이 순서가 정해지지 않은 `<type, length, value>`의 형태로 IP 헤더의 끝에 모두 감추어져 있기 때문이다. 반대로 IPv6에서는 옵션이 존재한다면, 정해진 순서에 따라 나타나는 `확장 헤더`로 다루어진다. 이것은 각 라우터가 어떤 옵션이 그 라우터에 관계되는지를 신속히 결정할 수 있다는 것을 의미한다. 라우터와 관계없이, 단지 NextHeader 필드를 관찰함에 의해 결정할 수 있다. 결과적으로 옵션 처리가 IPv6에서 훨씬 효율적이며 라우터의 성능에 중대한 영향을 미친다. 더욱이 IPv4에서는 최대 44바이트로 제한되어 있는데 반하여 옵션을 확장 헤더로 나타내는 새로운 형식에서는 임의의 길이가 될수 있음을 의미한다.
- 각각의 옵션은 그 자신의 확장 헤더 타입을 가지고 있다. 각각의 확장 헤더의 타입은 선행 헤더의 NextHeader 필드의 값에 의해 구분된다. 그리고 각각의 확장 헤더는 다음 헤더를 구분하기 위한 NextHeader 필드를 포함하고 있다. 마지막 확장 헤더 다음에는 트랜스포트 계층 헤더가 오고, 이 경우 NextHeader 필드 값이 IPv4 헤더 안의 Protocol 필드의 값과 같다.
- IPv6 헤더의 NextHeader 필드에는 다음헤더가 단편화 헤더라는 것을 나타내는 44라는 값이 표시될 것이다. 이 경우 단편화 헤더의 NextHeader 필드는 그것 다음에 올 헤더를 지정하는 값을 포함한다.

#### 자동구성
- IPv6의 목표는 플러그 앤 플레이라 하는 동작으로 자동 구성을 지원하는 것이다.
- 자동 구성은 IPv4에서도 가능하지만, DHCP 클라이언트에게 주소와 다른 구성 정보를 전해 주도록 구성된 서버가 있느냐에 달려 있다. IPv6의 좀더 긴 주소 형식은 비상태적이라고 불리는 유용하고 새로운 형태의 자동 구성을 제공할 수 있도록 한다. 이것은 서버를 필요로 하지 않는다.
- IPv6 유니캐스트 주소가 계층적이고, 최하위 부분이 인터페이서 ID이다. 그러므로 자동 구성 문제는 호스트가 접속된 링크 상에서 유일한 인터페이스 ID를 얻는것과 서브넷을 위한 올바른 주소 프리픽스를 얻는 것이다.
- 한 링크 상에 있는 모든 호스트는 유일한 링크 레벨 주소를 가지고 있어야 하므로 첫 번째 부분은 비교적 쉬운 문제다. 전역적으로 유효한 주소를 필요로 하는 장치는 같은 링크 상에 존재하는 라우터에 의지하는데, 이 라우터는 그 링크에 대한 적절한 프리픽스를 주기적으로 전파한다. 이는 라우터가 반드시 올바른 주소 프리픽스를 가지고 구성되어 있고 이러한 프리픽스는 적절한 링크 레벨 주소를 뒤에 첨가할 수 있을 정도로 충분한 공간이 남아 있도록 선택되어야 한다는 것을 의미한다.

#### NAT(네트워크 주소 변환)
- IP 주소 공간을 보호하기 위한 방법으로 널리 사용된다.
- 기본적인 개념은 인터넷 상에서 서로 통신하는 모든 호스트들이 전역적으로 유일한 주소를 가질 필요가 없다는 것이다. 대신에 호스트는 전역적으로 유일할 필요가 없는 `사설 주소`를 할당받을 수 있다. 
- 사설 주소는 전역적으로 유일할 필요가 없으며 일부 제한된 영역에서만 유일하면 된다.
- 호스트가 기업 네트워크 밖의 다른 호스트와 통신하고 자 한다면, 호스트에 의해 사용된 사설 주소를 NAT 박스에 할당된 전역적으로 유일한 주소로 변환시킬 수 있는 `NAT 박스`를 경유해야만 한다. NAT 박스는 전역적으로 유일한 주소들의 모임을 가지고 있으며 그 주소 개수는 기업의 모든 호스트들이 전역적으로 유일한 주소를 가질 경우 필요한 수보다 훨씬 작을 것이다.
- NAT 박스를 기업 내부의 호스트로부터 IP 패킷을 받고 사설 주소인 발신지 IP 주소를 전역적으로 유일한 주소로 변환시켜 주는 것이라고 생각할 수 있다.
- NAT의 단점은 모든 노드들이 전역적으로 유일한 주소를 가지고 있다는 IP 서비스 모델의 중요한 가정을 깨뜨린 것이다.
- IPv6의 도입을 늦추는데 한 몫 하고 있다.

#### 진보된 라우팅 능력
- IPv6의 확장 헤더중 하나는 라우팅 헤더이다.
- 라우팅 헤더는 목적지까지 라우팅을 위해 방문해야 하는 노든 또는 토폴로지 지역을 나타내는 IPv6 주소 목록을 포함하고 있다.
- 개별 노드가 아닌 토폴로지에 근거하여 객체를 지정하는 능력을 제공하기 위해, IPv6는 애니캐스트 주소를 정의 한다. 애니캐스트 주소는 인터페이스의 집합에 부여되며, 그 주소로 전송된 패킷은 인터페이스 중 가장 가까운 곳으로 전송된다. 가깝다는 것은 라우팅 프로토콜에 의해 결정된다.
- 애니캐스트 주소와 라우팅 헤더는 이동 호스트를 위해 강화된 라우팅에서 사용될 수 있다.
