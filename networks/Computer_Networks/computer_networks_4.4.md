# 인터네트워킹

## 멀티캐스트
- 기본적인 IP 멀티캐스트는 각각의 멀티캐스트 주소를 공유하고 있는 멀티캐스트 그룹에 기반을 둔 다중대 다중 모델이다. 그 그굽의 멤버인 호스트는 그 그룹의 멀티캐스트 주소로 전송되는 패킷의 사본을 받을 수 있다. 
- 유니캐스트 주소는 노드나 인터페이스에 대응되는 것으로 그리고 멀티캐스트 주소는 구성원들이 시간에 따라 변화하는 그룹에 대응되는 것으로 생각할 수 있다. 원래의 IP 멀티캐스트 서비스 모델에서는 어느 호스트도 그룹에 멀티캐스트 트래픽을 보낼 수 있으며, 송신 호스트가 반드시 그룹에 속해야 하는 것도 아니다.
- IP 멀티캐스트를 이용하여 그룹에 속한 멤버들에게 동일한 패킷을 보내려면 호스트는 그 그룹의 멀티캐스트 주소로 하나의 패킷을 보내면 된다. 그룹의 각 멤버에 대한 주소는 인터네트워크 내의 라우터들 사이에 분산되어 있기 때문이다.
- 점대다중 멀티캐스트 모델은 `송신지정 멀티캐스트(SSM)`이라 불린다. 수신 호스트는 특정 멀티캐스트 그룹과 송신 호스트를 지정하여야 한다. 수신 호스트는 지정된 송신자로부터 특정 그룹의 멀티캐스트 주소로 전송된 패킷만을 수신한다. 다중대 다중 모델은 `송신 미지정 멀티캐스트(ASM)`이라 한다.
- 호스트는 특정 멀티캐스트 그룹에 참가하거나 탈퇴하기 위하여 자신의 의도를 인접 라우터에 알려야 하는데, 이런 목적의 프로토콜을 IPv4에서는 `인터넷 그룹 관리 프토토콜(IGMP)`라 하고, IPv6에서는 `멀티캐스트 수신자 탐색(MLD)`라 한다. 그리고 라우터는 해당 호스트를 고려하여 정확하게 작동하는 멀티캐스트 동작을 지원하는 책임을 지고 있다.

### 멀티캐스트 주소
- IP는 멀티캐스트를 위하여 자신의 주소 공간 중 일부를 할당해 두고 있다. IPv4에서는 클래스 D를 사용하고 IPv6에서도 자신의 주소 공간 일부를 멀티캐스트 그룹 주소를 위하여 할당하고 있다.
- IPv4에서는 모든 멀티캐스트 주소가 공유하는 프리픽스 부분을 제외하면 28비트의 가능한 멀티캐스트 주소 공간이 가능하다. 이는 LAN 상에서 하드웨어 주소를 직접 사용하려는 시도에 문제가 발생한다. 이는 IP 멀티캐스트 주소의 위쪽 5비트를 무시하고 아래쪽 23비트를 취하여 이더넷의 멀티캐스트 주소로 사용하는 방식으로 구현할 수 있다. 따라서 32개의 IP 주소가 하나의 이더넷 주소에 대응된다.
- 이더넷 상의 호스트가 IP 멀티캐스트 그룹에 참여하고자 할때, 호스트는 자신의 이더넷 인터페이스를 해당 이더넷 멀티캐스트 주소로 전달되는 모든 패킷을 수신하도록 설정해 두어야 한다. 그러므로 수신 호스트는 모든 IP  패킷의 헤더를 검사하여 패킷이 자신이 원하는 그룹에 속한 것인지를 판단해야 한다. 요약하자면 멀티캐스트 주소 길이의 부조화는 멀티캐스트 그룹으로 전달되는 트래픽에 관심이 없는 호스트에게 까지 부담을 초래한다는 것이다. 일부 스위치 방식의 네트워크에서는 스위치가 원하지 않는 패킷을 감지하여 제거하는 기법을 사용하여 문제를 해결하기도 한다.

### 멀티캐스트 라우팅
- 라우터의 포워딩 테이블은 특정 IP 주소에 대하여 어떤 링크를 사용할 것인지를 지정해 준다. 멀티캐스트 지원하기 위하여 라우터는 추가적으로 멀티캐스트 포워딩 테이블을 가져야 하며, 이 테이블에는 멀티캐스트 패킷을 전송하기 위하여 어떤 링크를 사용할 것인지를 지정해야 한다.
- 멀티캐스트 포워딩 테이블은 전체적으로 트리의 집합, 즉 멀티캐스트 분산 트리를 지정하고 있다. 또한 송신지정 멀티캐스트를 지원하기 위하여 포워딩 테이블에는 멀티캐스트 주소와 발신지(유니캐스트) IP 주소의 조합을 기반으로 어떤 링크를 이용할 것인지를 지정하고 있다. 이 테이블은 경로가 아닌 트리 형식으로 설정되어 있다.
- 멀티캐스트 라우팅이란 멀티캐스트 트리를 설정하는 절차, 즉 구체적으로 멀티캐스트 포워딩 테이블을 구성하는 절차를 의미한다.

#### DVMRP
- 유니캐스트의 거리 벡터 라우팅은 멀티캐스트를 위하여 확장될 수 있다. 그 결과로 `거리-벡터 멀티캐스트 프로토콜(DVMRP)`이 제안되었다. 광범위하게 사용된 첫 번째 멀티캐스트 프로토콜이다.
- 멀티캐스트를 지원하기 위해 이 알고리즘을 확장하는 것은 2단계로 이루어 진다.
- 첫 번째는 인터넷에 있는 모든 네트워크에게 패킷을 전송하기 위한 브로드캐스트 방식을 설계할 필요가 있다.
- 두 번째는 멀티태스크 그룹에 속한 호스트를 갖지 않는 네트워크를 제거하기 위해 이 방식을 개선할 필요가 있다. 결론적으로 DVMRP는 `확산-제거`프로토콜로 일컬어지는 몇 가지 프로토콜 중 하나임을 알수 있다.
- 주어진 유니캐스트 라우팅 테이블에서 각 라우터는 특정 목적지로 가는 최단 경로는 Nexthop을 통한다는 것을 알고 있다. 그러므로 라우터가 발신지 S로부터의 멀티캐스트 패킷을 수신하면 라우터는 패킷이 S로 가는 최단 경로 상의 링크를 통해 수신된 경우에만 그 패킷을 모든 출력 링크로 포워딩한다.
- 이 방식에는 두가지 단점이 있다. 하나는 해당 멀티캐스트 그룹의 멤버가 없는 LAN을 제외하는 방안이 제공되지 않는다. 두 번째는 해당 패킷이 그 LAN에 접속되어 있는 라우터들 모두에게 포워딩된다는 것이다. 이는 최단거리 트리에 속하는지에 대한 판단에 근거하지 않고, 패킷을 수신한 링크를 제외한 다른 모든 링크로 패킷을 확산시키는 정책 때문이다.
- 두 번째 한계에 대한 해결책은 주어진 LAN에 연결된 여러 개의 라우터가 있을 경우 발생되는 중복된 브로드캐스트 패킷을 제거하는 것이다. 이를 수행하는 한 방법은 한 라우터를 발신지에 대응되어 각 링크의 부모 라우터로 지정하고, 이 부모 라우터만이 그 발신지로부터 해당 LAN에 도착한 패킷을 포워딩하는 방식이다. 발신지 S로 가는 최단거리상에 잇는 라우터가 부모 라우터로 선정되며, 두개의 라우터가 동일 거리에 있는 경우에는 작은 주소를 가진 라우터가 선정된다.
- 이와 같은 개선방식에서는 모든 라우터가 각 발신지에 관련하여 자신이 특정 발신지/링크 쌍에 대하여 부모 라우터인지를 알려주는 한 비트를 유지해야 한다. 여기서 라우터는 네트워크 간에 패킷을 포워딩하는 기능을 담당하고 있으므로 인터넷에서의 발신지랑 호스트가 아니라 네트워크이다. 이 결과로 고안된 방식을 `역경로 브로드캐스트(RPB)` 혹은 `역경로 포워딩(RPF)`라 한다. 멀티캐스트에서는 발신지로의 최단거리를 고려하여 포워딩 판단을 하기 때문에 이런 경로를 역경로라 한다.
- RPB기법은 최단거리 브로드캐스트이다. 특정 그룹 G의 주소를 가진 패킷을 받은 네트워크들 중에서 G의 멤버를 가지고 있지 않은 네트워크를 제외하는 기법이 요구된다. 이 절차는 두 단계로 이루어진다.
- 첫째는 말단 네트워크가 그룹의 멤버를 가지고 있지 않다는 것을 인식할 수 있어야 한다. 특정 그룹의 멤버가 네트워크에 존재하는지를 판단하는 방식은 그룹의 멤버인 호스트가 그 사실은 주기적으로 네트워크를 통해 브로드캐스트 하는 것이다. 라우터는 이 정보를 이용하여 G로 가는 주소를 가진 멀티캐스트 패킷을 해당 LAN으로 포워딩할지를 결정한다.
- 두 번째는 여기에는 G의 멤버가 없음이라는 정보를 최단거리 트리를 거슬러 전파하는 단계이다. 이 단계는 라우터가 말단 네트워크에서 받고자 하는 멀티캐스트 패킷의 그룹 목록을 `<Destiantion, Cost>`쌍으로 표현하여 이웃 라우터들에게 전파하는 것이다. 이정보는 라우터에서 라우터로 전파되어 해당 라우터는 각각의 링크에 대하여 어떤 그룹의 멀티캐스트 패킷을 포워딩해야 하는지를 판단하게 된다.
- 특정 발신자가 특정 그룹에 패킷을 전송하기 시작할때 정보가 교환된다. 멀티캐스트 주소가 활성화되는 시점에 이 그룹의 주소로 가는 패킷을 받지 않겠다는 라우터가 대화를 시작하고 이 정보가 이웃 라우터로 전파되는 것이다.

#### PIM-SM
- PIM은 초기의 멀티캐스팅 라우팅 프로토콜에 존재하는 확장성 문제에 대한 해결책으로 개발되었다. PIM은 프로토콜에 독립적인 특성을 가지고 있는데, DVMRP와 달리 PIM은 특정 유니캐스트 프로토콜과 무관하다. 어떤 유니캐스트 프로토콜과도 같이 사용할 수 있다.
- PIM은 희박 모드와 조밀모드로 나눈다. 조밀 모드에서는 DVMRP와 같은 전파 후 제거 알고리즘을 사용하므로 여전히 확장성의 문제를 가지고 있다. 
- `희박 모드(PIM-SM)`에서 라우터들은 join과 prune 메시지라는 PIM 프로토콜 메시지를 사용하여 명시적으로 특정 멀티캐스트 그룹에 가입하거나 탈퇴한다. DVMRP에서는 브로드캐스트 트리를 먼저 만들고 불필요 라우터를 제거하는 것과 대비된다.
- 특정 호스트가 멀티캐스트 그룹에 전송하기 위하여 join 메시지를 보낼 곳을 지정하기 위해서 PIM은 각 그룹에 `랑데뷰 지점(RP)`을 할당한다. 일반적으로, 도메인 내의 일부 라우터들이 RP 후보자로 설정되고, PIM은 도메인 안의 모든 라우터들이 그 중 한 라우터를 주어진 그룹을 위한 RP로 사용되도록 한다.
- 멀티캐스팅 포워딩 트리는 라우터들이 RP에 join 메시지를 보낸 결과로 만들어진다. PIM-SM은 두 종류의 트리를 만든다. 모든 송신자들에 의해 사용될 공유 트리, 특정 송신 호스트에 의해 사용될 발신지 지정 트리가 그것이다. 보통 모드의 동작에서는 공유 트리가 먼저 만들어지고 연이어 각 발신지별로 새로운 트리로 만들어야 할 정도로 충분한 트래픽이 예상되면 여러개의 발신지 지정 트리가 만들어진다. 트리를 만든다는 것은 그 트리에 속한 모든 라우터 내에 상태를 설정한다는 것이므로 그룹의 각각의 송신자를 위하여 하나의 트리를 개별적으로 가지는 것보다 그룹마다 단 하나의 트리만을 갖는 것을 기본으로 하는 것이 중요하다.
- 라우터가 그룹 G로 join 메시지를 보낼 때, 일반적인 IP 유니캐스트 전송을 사용한다. 최초의 join 메시지는 미지정이다. 모든 송신자들을 포함한다는 의미이다. join 메시지가 RP에 도달하기까지 반드시 정해진 순서의 라우터들을 통과해야 한다. 
- 이 경로 상의 각 라우터는 join 메시지를 보게 되고, 공유 트리에 대한 엔트리를 포워딩 테이블에 만든다. join 메시지가 수신되었던 인터페이스는 포워딩 테이블 엔트리에 해당 그룹으로 전송된 데이터 패킷을 포워딩해야 하는 인터페이스로 기록해 둔다. 그 다음 RP로 join을 포워딩 하기 위해 사용할 인터페이스를 결정한다. 이 인터페이스는 해당 그룹으로 전송된 패킷이 도착되도록 허락된 유일한 인터페이스다. 마침내 메시지는 RP에 도착하고, 트리의 가지가 완전하게 만들어진다. RP로 join을 보내는 라우터가 늘어남에 따라 새로운 가지들이 트리에 추가된다. 
- 어떤 호스트가 특정 그룹으로 메시지를 보내려고 한다면, 호스트는 해당 그룹 주소를 목적지 주소로 하는 패킷을 만든 후, 그 패킷을 `지정 라우터(DR)`로 알려진 자신의 지역 네트워크 내의 한 라우터로 전송한다. 
- DR은 멀티캐스트 패킷을 RP의 유니캐스트 주소를 목적지로 하는 IP 패킷에 캡슐화 시킨다. RP는 자신의 주소를 목적지로 수신된 패킷을 받고 이 유니캐스트 패킷의 페이로드를 조사하여 수신된 패킷의 내부에 멀티캐스트 주소를 목적지로 하는 IP 패킷을 발견한다. RP를 루트로 하는 공유트리를 통하여 패킷을 전송한다.
- 대역폭의 비효율성과 RP로 가는 도중의 패킷 캡슐화와 캡슐 제거에 대한 처리비용이 존재하므로 RP는 중간 라우터들이 터널링을 피할수 있도록 해당 그룹에 대한 정보를 라우터들에게 알려 주어야 한다. RP는 송신 호스트로 join 메시지를 전송한다. 이 join 메시지가 호스트 쪽으로 전달되면서 그 경로에 있는 라우터는 지정된 그룹에 대해 알게 되고, 이 과정을 통해 DR이 터널링 되지 않은 멀티캐스트 패킷으로 해당 그룹에 패킷을 전송할 수 있게 될 것이다.
- RP로부터 송신 호스트로 전송되는 join 메시지는 특정 송신자를 지정한다. 따라서 새로운 join의 결과로 동일한 발신지와 RP 사이의 중간 라우터들에 송신자 지정 상태가 만들어지게 된다. 이것은 모든 수신자와 RP 사이에 설정되어 모든 송신자들에게 적용되는 기존의 상태와 대조적으로 단 하나의 송신자에만 적용된다.
- 공유 트리 전체를 지정 트리로 대체하게 하는 최적화 방법이 있다. 이것은 송신자로부터 RP를 경유하여 수신자까지 가는 경로가 가능한 한 최단 경로보다 훨씬 긴 경우 바람직하다.
- PIM이 프로토콜 독립적인 이유는 트리를 만들고 유지하기 위한 모든 메커니즘은 어떤 유니캐스트 라우팅 프로토콜이 도메인에서 사용되는지에 무고나하다. 트리의 구성은 전적으로 join 메시지가 따라가는 경로에 의하여 결정된다. 이 경로는 유니캐스트 라우팅에 만들어진 최단 경로의 선택에 의하여 결정된다. 정확히 말하면 `유니캐스트 라우팅 프로토콜에 독립적`이라고 해야 한다.
- PIM은 인터넷 프로토콜과 밀접한 관계가 있다. 즉 네트워크 계층에 대하여 독립적인 프로토콜이 아니라는 것이다. 공유 트리는 라우터에서 유지해야 하는 상태가 줄어든다는 의미에서 확실히 발신자 지정 트리보다 확장성이 있지만, 효과적인 라우팅과 링크 대역폭의 효과적인 사용을 위해서는 발신자 지정 트리가 필요할 것이다.

#### 도메인 간 멀티캐스트
- PIM-SM이 도메인 간 멀티캐스트로 사용되기에는 결점이 존재한다. 특히 그룹당 하나의 RP가 존재해야 한다는 것은 도메인이 독립적이야 한다는 원칙에 위배된다. 결과적으로 PIM-SM은 도메인 내부에서만 가능하고 도메인 간에는 일반적으로 사용하지 못한다.
- `멀티캐스트 발신자 검색 프로토콜(MSDP)`는 PIM-SM을 도메인 간 멀티캐스트로 확장한 것이다. 이것은 서로 다른 도메인을 연결하기 위하여 사용된다.
- 각 도메인은 내부적으로 PIM-SM을 수행하고 있으며, 다른 도메인의 RP를 연결하는 기능을 수행한다. 각각의 RP는 다른 도메인의 하나 혹은 그 이상의 RP 피어와 연계된다. MSDP 피어의 쌍은 TCP 연결에 의해 연결되고 이 연결 위에서 MSDP 프로토콜이 수행된다. 동시에 특정 멀티캐스트 그룹의 모든 MSDP 피어들은 브로드캐스트 네트워크로 사용되는 불완전 mesh를 형성한다. 피어 RP 간의 mesh를 통하여 MSDP 메시지가 브로드캐스트 되는데 이를 위하여 역경로 브로드캐스트 알고리즘이 사용된다.
- RP의 메시를 통한 MSDP 브로드캐스트를 통하여 교환되는 정보는 발신자 정보이다. 각 RP는 새로운 발신자가 나타날 때마다 register 메시지를 받으므로 RP는 자신의 도메인 내의 발신자에 대하여 알고 있다. 각 RP는 MSDP 를 이용하여 주기적으로 자신의 피어들에게 sourceActive 메시지를 브로드캐스트한다. 이 메시지에는 발신지 IP 주소, 그룹의 멀티캐스트 주소, 메시지를 생성한 RP의 IP 주소가 포함되어 있다.
- 브로드캐스트 메시지를 수신한 MSDP의 피어 RP가 해당 멀티캐스트 그룹의 활성 수신자를 가지고 있는 경우, 원래의 RP를 대신하여 발신 호스트로 발신자 지정 join 메시지를 보내준다. join 메시지는 RP를 정점으로 하는 발신자 지정트리의 한 가지를 형성한다. 결과적으로 MSDP 네트워크의 일부분으로 특정 멀티캐스트 그룹의 활성 수진자를 가지고 있는 모든 RP는 새로운 발신자의 발신자 지정 트리에 추가된다. RP가 발신자로부터 멀티캐스트를 수신하면 RP는 이를 자신의 도메인 내의 수신자들에게 포워딩한다.

#### 발신자 지정 멀티캐스트
- PIM-SM은 초기에 공유 트리를 사용하다가 이를 최적화한 결과로 발신자 지정 최단 경로 트리로 만들어진다. 본래의 PIM 설계에서는 이 최적화 과정이 호스트에는 알려지지 않는다. 다만 발신자 지정 트리에 참여하고 이는 라우터에게만 알려질 뿐이다. 그러나 점 대 다중 서비스 모델의 필요성이 대두되면서 PIM-SM의 발신자 지정 라우팅 기능이 호스트들에게도 확대 적용되었다. 이 변화로 인하여 PIM 자체보다는 IGMP나 IPv6에서 MDP에서의 변화가 유발되었다. 이런 새로 적용된 기능을 `PIM 발신자 지정 멀티캐스트(PIM-SSM)`이라 한다.
- PIM-SSM은 채널이라는 새로운 개념을 도입한다. 이것은 발신자 주소 S와 그룹 주소 G의 조합으로 구성된다. 그룹 주소 G는 일반적으로 IP 멀티캐스트 주소와 같으며 IPv4나 IPv6에서는 SSM에 할당된 멀티캐스트 주소 공간의 일부를 여기에 할당하고 있다.
- PIM-SSM을 사용하기 위하여 호스트는 IGMP의 membership Report 메시지를 통해 자신이 접속하고 있는 라우터에 그룹과 발신자 주소를 지정해 주어야 한다. 해당 라우터는 발신자에게 PIM-SM의 발신자 지정 join 메시지를 보내고, 자신을 발신자 지정 트리의 새로운 가지로 추가한다. 이 과정은 일반적인 PIM-SM에서 공유 트리의 전체 단계를 생략한다는 점을 제외하고는 동일하다. 결과적으로 생성된 트리는 발신자 지정트리이므로 지정된 발신자만이 이 트리를 통해 패킷을 전송할 수 있다.

#### 양방향 트리
- BIDIR-PIM은 PIM-SM의 새로운 변종으로써 같은 도메인 내에서 다중 대 다중 멀티캐스트, 특히 발신자들과 수신자들이 같은 그룹에 소속된, 다중 화상회의와 같은 환경에 적합한 모델이다.
- PIM-SM에서와 마찬가리조 수신자는 IGMP Membership Report 메시지를 보내서 그룹에 참가하고, RP를 정점으로 하는 트리를 통하여 멀티캐스트 패킷이 포워드된다. 그러나 PIM-SM과 달리 공유트리에는 발신지로 가는 가지가 존재한다. 이는 단방향의 PIM-SM 트리에서는 의미가 없으나, BIDIR-PIM의 트리는 양방향성이라는 점에서 차이가 있다.
- 아래 방향의 가지에서 멀티캐스트 패킷을 수신한 라우터는 그 패킷을 트리를 따라 위로 혹은 아래 방향의 다른 가지를 따라 전송할 수 있다.
- BIDIR-PIM은 RP가 없다. 단지 필요한 것은 라우팅이 가능한 주소만이다. 이 주소는 RP 주소라 알려져 있지만 반드시 RP 주소일 필요도 없고 어떤 주소라도 무관하다. 수신자로부터의 join은 RP를 향해 포워딩되는데 이 join 메시지의 전달은 RP의 주소로 설정되어 있는 링크 인터페이스를 가진 라우터에 도착할 때 종료된다. 이 라우터는 위로 향하는 포워딩의 마지막 단계로 멀티캐스트 패킷을 바로 그 링크로 포워딩하여 링크의 반대쪽에 연결되어 있는 라우터가 이 패킷을 수신하도록 한다.
