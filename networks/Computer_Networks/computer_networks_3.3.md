# 패킷 교환

## 셀 스위칭
- ATM(비동기 전송 모드)는 연결성 패킷 교환망이다. 가상회선을 사용한며,  ATM의 연결 설정 단계는 시그널링이라고 한다. 
- 주요 ATM 시그널링 프로토콜은 Q.2931이다. 이것은 ATM 네트워크를 거쳐 적절한 경로를 발견하는 일외에도 회선상의 교환기에서 자원을 할당하는 일도 책임져야 한다. 이 작업은 회선이 특정 서비스 품질을 확실히 지원하게 하는 과정에서 이루어진다.
- 어떠 가상 회선이 설정될때, 시그널링 메시지에 목적지의 주소를 넣는 것이 필요하다. ATM에서 이 주소는 여러 형태 중의 하나가 될 수 있는데, 가장 널리 사용되는 것은 E.164와 NSAP이다. 이들은 전통적인 LAN에서 사용되는 MAC 주소와는 다르다.
- ATM 네트워크의 특징중 하나는 교환 되는 패킷의 길이가 고정되어 있다는 점이다. 이 길이는 53바이트로, 5바이트의 헤더에 이어 48바이트의 페이로드로 구성된다. 이 고정 길이 패킷을 보통의 컴퓨터 네트워크에서 사용되는 가변 길이 패킷과 구분하기 위해 `셀`이라는 이름이 붙여진다.

### 셀
- 가변 길이 패킷은 패킷의 길이가 대개 어떤 범위 안에 들도록 제한한다. 하한선은 패킷에 포함되어야 하는 정보의 최소 양으로 결정되는데, 대개 선탁적 확장부분이 없는 헤더 길이가 된다. 상한선은 여러가지 요소에 의하여 결정된다.

#### 셀 크기
- 가변 길이 패킷은 몇가지 좋은 특징을 갖고 있다. 1바이트를 보내려면 최소 길이 패킷에 넣는다. 그러나 하나의 큰 파일을 보내려면 파일을 최대 길이 패킷으로 필요한 개수만큼 잘라서 보낸다. 앞의 경우에는 패딩을 보낼 필요가 없으며, 뒤의 경우에는 데이터에 대한 헤더의 비율을 낮추어 결국 대역폭의 효율을 높인다. 또, 보내는 패킷의 총 수를 최소화하며 이에 따라 패킷당 작업에 의한 총 처리 부하도 최소화된다. 이 점은 높은 처리량을 얻기 위해서는 특히 중요할 수도 있다. 많은 네트워크 장비는 초당 얼마나 많은 비트를 처리할 수 있는지가 아니라, 초당 처리하는 패킷의 수에 의하여 제약을 받기 때문이다.
- 고정 길이의 패킷이 도움이 될 것이로 인식된 이유는 간단한 일을 하는 하드웨어를 만드는 일은 용이하며, 패킷의 길이가 얼마인지를 이미 알고 있을 때 패킷을 처리하는 일이 간단해지는 것과 모든 패킷의 길이가 같다면, 많은 스위칭 소자를 두고 이들 모두가 똑같은 일을 병렬로 수행하도록 할 수 있다. 이때 각 스위칭 소자가 임무를 수행하는데 같은 시간이 걸린다.
- 셀의 또 다른 장점은 큐의 동작과 관련이 있다. 큐는 교환기에 여러 입력으로부터의 트래픽이 하나의 출력으로 향할 때 발생된다. 일반적으로 큐에서 하나의 패킷을 꺼내서 보내기 시작하면 그 패킷이 완전히 전송될 때까지 계속해서 출력해야 한다. 즉, 패킷의 전송을 중간에 중단시키고 다른 일을 하는 것은 바람직하지 못하다. 큐의 출력에 묶일 수 있는 최장 시간은 최대 길이 패킷을 전송하는 데 걸리는 시간과 같다. 
- 그러나 고정 길이 셀에서는 하나의 셀을 전송하는 데 걸리는 시간보다 많은 시간 동안 큐의 출력에 묶이는 일은 없게 된다. 이때 셀의 길이는 일반적으로 가변 길이 패킷 네트워크의 최대 길이 패킷보다는 짧다. 따라서 셀이 큐를 통과할 때 겪게 되는 소요시간을 엄격히 제어하는 것이 중요하다면 셀 방식이 좋다. 셀을 통해 얻을 수 있는 것은 훨씬 짧아진 큐가 아니라 큐의 동작을 보다 미세하게 제어할 수있는 잠재력이다. 특히 지연시간을 제어하는 능력은 애플리케이션에 따라 중요할 수 있다.
- 셀의 큐는 패킷의 큐보다 약간 짧다. 패킷이 빈 큐에 도착하기 시작할 때, 교환기는 대개 패킷 전체가 도착하는 것을 기다린 후에 패킷을 출력 링크로 전송을 시작할 수 있다. 이는 링크가 패킷이 도착하는 동안에는 유휴 상태로 있어야 한다는 것이다. 그러나 하나의 긴 패킷이 작은 셀의 연속으로 대체된다면, 연속되는 셀중 첫 번째 셀이 큐에 넣어지자마자 교환기는 전송을 시작할 수 있다.

#### 셀의 길이 문제
- 패킷을 너무 짧게 만들면, 한 셀에 들어가는 데이터의 양에 비해 전달해야 하는 헤더 정보의 양이 점점 커지게 된다. 실제 사용되는 링크 중에서 데이터가 차지하는 비율이 떨어지게 된다. 특히, 초당 정해진 최고 숫자의 셀 비율로 셀 처리 장비를 만들었다면, 셀이 점점 작아지면 총 데이터 비율은 셀 길이에 비례해서 떨어진다.
- 셀이 너무 크면 하나의 완전한 셀을 만들기 위해 패딩해야 하는 데에서 생기는 대역폭의 낭비 문제가 생긴다. 페이로드 크기가 48바이트인데 1바이트만을 보내려 하면 47바이트의 패딩을 보내야 한다. 이러한 일이 많이 발생하면 링크의 효율은 매우 낮아진다.
- ATM 표준화에서는 셀 페이로드의 길이로 48바이트다.

#### 셀 형태
- ATM 셀은 실제로는 네트워크의 어느 위치에서 보는가에 따라 두 가지 다른 형태를 가진다. UNI와 NNI이다.
- UNI는 호스트와 교환기 사이에서 셀을 전송할 때 사용되는 것이며, NNI는 교환기 사이에서 셀을 전송할 때 사용된다. 유일한 차이는 NNI 형태는 UNI의 GFC 필드를 없애고 VPI의 확장에 사용한 점이다.
- UNI 셀은 4비트의 GFC를 포함하는데 가입자와 교환국 간에 국지적인 의미를 갖도록 되어 있으며, 네트워크에서는 다른 용도로 사용될 수 있다. GFC 비트가 가진 기본 개념은 가입자가 ATM 망에 접속하기 위해 어떤 공유매체를 사용한다면, 링크의 접근을 조정하는 수단을 제공하자는 것이다.
- 8비트 가상 경로 식별자(VPI)와 16비트 가상 회선 식별자(VCI)를 포함한다. 이 부분은 가상 연결을 식별하기 위해 사용되는 하나의 24비트 식별자이다.
- Type필드: 첫 번째 비트가 1일때 다음 네 개의 값은 네트워크 관리 기능과 관계가 있다. 첫 비트가 0이면 셀이 사용자의 데이터를 갖고 있다는 것을 의미한다. 두 번째 비트는 EFCI비트이고 혼잡이 발생한 교환기가 종단 노드에게 혼잡 사실을 알리기 위해 1로 설정할 수 있다, 세 번째 비트는 user signalling 비트이며 프레임을 구분하기 위해 사용된다.
- CLP는 사용자나 네트워크 요소는 과부하가 생겼을 때 셀이 버려져야 하는데 이 경우 우선순위를 나타내기 위해 이 비트를 1로 설정한다.
- HEC는 8비트 CRC로 CRC-8 다항식을 사용하며, 셀 헤더에 대해서만 오류 검출과 1비트 오류 수정 능력을 갖고 있다. VCI에서 오류가 발생하면 셀이 다른 곳으로 전달되므로 셀 헤더를 보호하는 것이 특히 중요하다.

### 분할 및 재조립
- ATM은 위로부터 받은 패킷이 종종 48바이트보다 크고, 따라서 ATM 셀의 페이로드에 맞지 않기 때문에 셀 단위로 분리해야 한다. 즉, 발신지에서는 상위 단계의 메시지를 하위 단계의 패킷으로 분할하고, 각각의 하위 단계 패킷을 네트워크로 전송하며, 목적지에서는 이 단편을 재조립한다. 이것을 `단편화 및 재조립`이라고 한다. ATM의 경우는 `SAR`이라고 한다.
- 가변 길이 패킷 프로토콜과 ATM 사이에 새로운 프로토콜이 추가된다. `ATM 적응 계층(ALL)`이라고 하며, ALL 헤더는 목적지에서 개개의 셀을 원래의 메시지로 재조립하는 데 필요한 정보만을 포함하고 있다고 할 수 있다.
- 처음에는 네가지 적응 계층이 정의되었다. AAL1과 2는 음성과 같이 보장된 비트율이 필요한 애플리케이션을 지원하기 위해 정의되었으며, AAL3과 4는 ATM 위에서 동작하는 패킷 데이터를 지원하려는 의도를 갖고 있었다. AAL3은 X.25와 같은 연결성 패킷 서비스가 사용하고, AAL4는 IP와 같은 비연결성 서비스가 사용하자는 생각이었다. 최종적으로는 이 두 종류의 서비스에 대해 다른 AAL을 사용할 이유는 충분하지 않다고 판단되어, AAL3/4라는 하나의 AAL로 합쳐졌다. AAL3/4의 단점들을 인식한 사람들이 AAL5라 하는 5번째 AAL을 제안하였다.

#### AAL 3/4
- 가변 길이 패킷이 ATM 네트워크를 통해 고정 길이 셀의 연속으로 전송될 수 있도록 충분한 정보를 제공하는 것이다. AAL은 분할 및 재조립 과정을 지원한다. 네트워크 계층 구조에서 새로운 계층을 다르게 되므로 패킷을 지칭하는 새로운 이름이 필요하다. 이를 `프로토콜 데이터 단위(PDU)`라 한다. 분할 및 재조립의 작업은 두 개의 다른 패킷 형태를 다룬다. 이 중 하나는 `수렴 부계층 프로토콜 데이터 단위(CS-PDU)`이다.
- CS-PDU는 가변 길이 PDU를 셀로 분할하기에 앞서 포장하는 방법을 정의한다. AAL에게 전달된 PDU는 헤더와 트레일러가 추가되어 포장되며, 그 결과인 CS-PDU는 ATM 셀로 분할된다.
- CS-PDU 형태는 8비트의 공통 부분 표시지(CPI)로 시작된다. 이것은 버전 필드와 유사한 것으로 어느 버전의 CS-PDU 형태가 사용되고 있는가를 나타낸다. 
- 다음으로 8비트 Btag가 온다. 이것은 각 PDU에 대해 종료표시(Etag)와 일치해야 한다. 표시를 일치시킴으로써 한 PDU의 마지막 셀과 다른 PDU의 첫 번째 셀이 상실되어, 두 개의 PDU가 하나의 PDU로 합쳐지고, 이것이 프로토콜 스택의 다음 계층에게 넘겨지는 사고를 막게 된다.
- 버퍼 할당 크기는 반드시 PDU의 길이를 나타내는 것은 아니며, 재조립 과정에게 재조립을 위해 얼마나 많은 버퍼를 할당해야 하는지에 고나한 정보가 되고 있다. 실제 길이를 여기에 넣지 않는 이유는 송신 호스트가 헤더를 송신할 때는 CS-PDU가 얼마나 긴지를 모를 수 있기 때문이다.
- CS-PDU 트레일러를 덧붙이기 전에 사용자 데이터가 4바이트의 배수가 되도록 3바이트까지 패딩이 이루어진다. 0으로 이루어진 바이트를 추가하는 이 패딩은 트레일러가 32비트 경계에 정렬되도록 해주며, 따라서 효과적인 처리가 가능하다.
- CS-PDU의 트레일러 자체는 Etag와 PDU의 실제 길이를 포함한다. CS-PDU의 헤더와 트레일러가 함께 있는 AAL3/4는 각 셀이 담고 갈 헤더와 트레일러도 규정한다. 실제 CS-PDU는 44바이트 단위로 나뉘며, 각 조각에 AAL3/4 헤더와 트레일러가 부착되어 48바이트가 도니다. 이것이 ATM 셀의 페이로드로 전달된다.
- AAL3/4 헤더의 처음 두비트는 Type필드로 이것이 CS-PDU의 첫 번째 셀인지, 마지막 셀인지, 중간에 속하는 셀인지, 또는 하나의 셀로 이루어진 PDU인지를 나타낸다.
- 4비트의 순서번호(SEQ)는 셀의 손실과 순서바뀜을 감지하여 재조립 과정에서 필요한 정보를 얻을 수 있도록 하는 의도를 갖고 있다. 순서번호가 작다면, 손실되는 셀의 개수가 충분히 큰 경우 셀 손실 사실을 놓칠 수 있다는 것은 쉽게 알수 있다.
- 다중화 식별자는 하나의 연결에 여러 PDU를 다중화할 때 사용된다.
- 6비트 길이 필드는 셀 안에 잇는 PDU의 바이트 수를 나타낸다. 길이 필드는 BOM 또는 COM 셀인 경우 반드시 44이어야 한다.
- 48바이트 셀 페이로드 내의 오류가 어디서 발생했는지를 감지하기 위해서 10비트 CRC가 사용된다.
- CS-PDU는 44바이트 페이로드로 분할되며, AAL3/4의 헤더와 트레일러에 5바이트의 ATM 헤더가 부착되어 ATM 셀로 포장된다. CS-PDU가 44바이트의 배수로 떨어지지 않을 때마다 마지막 셀은 부분적으로 채워진다는 점에 유의하자.
- 주의사항은 셀당 헤더 정보가 차지하는 비율이 높다는 점이다. 44바이트의 데이터당 9바이트의 헤더를 부착한다면, 최선으로 얻을 수 있는 대역폭 효율은 83%밖에 안된다. CS-PDU의 헤더/트레일러와 마지막 셀이 꽉 차지 않을 때도 있기 때문에 효율성은 훨씬 적을 수도 있다.

#### AAL 5
- AAL3/4가 개념적으로 간단한 기능인 분할 및 재조립을 수행하기 위해 많은 필드들 두고 있으며 이에 따라 부담도 크다는 점이다.
- 이를 개선하기 위해 AAL5가 하는 일은 AAL3/4의 2비트 Type 필드를 ATM 셀 헤더에 있는 1비트의 프레이밍 정보로 대체하는 것이다. 이 비트를 1로 설정함으로써 어떤 PDU의 마지막 셀이라는 것을 식별할 수 있다. 또, 다음 셀은 다음 PDU의 첫 번째 셀이라고 가정되며, 사용자 시그널링 비트가 1로 설정된 셀을 받기 전까지 이어지는 셀은 COM 셀로 가정도니다. EOM 셀의 손실을 포함한 셀의 손실, 변형, 순사바뀜등을 대비하기 위한 AAL3/4의 모든 정보는 AAL5의 CS-PDU 패킷에 의하여 제공된다.
- AAL5 CS-PDU는 데이터 부분과 8바이트의 트레일러로 구성된다. 
- 트레일러는 항상 ATM 셀의 끝에 오며, 데이터와 트레일러 사이에 47바이트까지의 패딩이 올수 있다. 트레일러는 반드시 셀의 끝에 위치해야 하는데, 그렇지 않으면 CS-PDU를 재조립할 때 트레일러를 찾아낼 수 있는 방법이 없기 때문이다. 트레일러의 처음 두 바이트는 앞으로의 사용에 대비한 예약 필드이며 0으로 설정되어야 한다.
- 길이 필드는 이 PDU가 운반하는 바이트 수를 나타내는데, 트레일러와 트레일러 앞에 오는 패딩은 포함하지 않은 길이를 나타낸다. 그리고 끝에 32비트 CRC가 온다.
- AAL5는 셀마다 추가의 4바이트를 사용하지 않으면서도 AAL3/4와 거의 같은 기능을 제공한다.
- 전체 PDU에 대해 체크섬하는 것이 AAL3/4에서와 같이 매 셀마다 체크섬하는 것보다 강한 보호를 한다.
- AAL5에서 없어진 주요 기능은 MID를 사용해서 하나의 가상 회선 위에 다중화 기능을 추가하는 능력이다. 그러나 패킷단위의 다중화로도 다중화가 가능하다.

### 가상 경로
- ATM은 가상 회선에 대해 24비트 식별자를 사용한다. 다른 점은 24비트 식별자가 8비트의 VPI와 VCI 두부분으로 나뉜다는 점이다. 이것은 두 단계 계층 구조의 가상 연결을 효과적으로 생성한다.
- 장점은 공중 네트워크를 거치는 수천, 수만의 가상 연결이 잇더라도, 공중 네트워크 안에 있는 교환기는 마치 하나의 연결만이 있는 것처럼 동작한다. 이것은 VCI마다 정보를 저장하는 크고 비싼 테이블을 피할 수 있기 때문에 교환기기가 훨씬 작은 연결상태 정보만을 저장해도 된다는 것을 의미한다.

###  ATM의 물리적 계층
- 프로토콜의 설계에서 계층적 방식을 사용한다면, ATM이 어떤 종류의 물리적 전송매체를 사용하는가에 대해 걱정할 필요가 없다. ATM 교환기를 위해 ATM 어댑터를 살때, ATM 셀이 전송되는 어떤 물리적 매체가 따라오게 된다. 802.5나 이더넷과 같은 다른 네트워킹 프로토콜에서도 마찬가지이다.
- ATM은 초기에 SONET 물리적 계층위에서 동작하는 것으로 가정되었다.
- ATM 셀을 SONET이 아닌 다른 많은 물리적 계층을 통해 전송하는 것도 가능하며, 이들에 대한 포장 방법의 표준도 정의되었다.
- ATM 셀을 어떤 물리적 매체를 통하여 보낼 때, 주요 문제는 어떻게 ATM 셀의 경계를 찾아내는가이다. 이것은 프레이밍 문제이다.
- SONET의 경우 경계를 찾는 두가지 쉬운 방법이있다. SONET 프레임 헤드 중의 한 필드를 SONET 페이로드에서 ATM 셀이 시작하는 곳에 포인터로 사용할 수 있다. 하나의 셀의 시작 위치를 알면 다음 셀은 SONET 페이로드에서 53바이트 떨어져 있는 곳에서 시작한다는 것을 알수 있다. 오류를 검출하고 필요에 따라 재동기를 이루기 위해서 SONET 부하가 지나갈 때마다 읽는 것이 바랍직하다. 또다른 방법은 모든 셀의 5번째 바이트는 CRC라는 것을 이용하는 것이다. 따라서 수신한 5바이트에 대해 CRC 계산을 수행하고, 그 결과가 오류가 아니면 하나의 ATM 헤더를 읽은것으로 생각할 수 있다. 이와 같은 일이 53바이트 간격으로 여러 차례 발생하면, 셀의 경계를 찾아다고 확신할 수 있다.
