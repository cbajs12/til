## MapReduce

### 맵 리듀스 잡 실행 - 요청
- 클러이언트는 `waitForCompletion` 메서드를 호출해 잡 실행을 요청한다.
- 클라이언트의 요청은 Job의 내부 컴포넌트인 JobClient에 전달된다.
- JobClient는 잡트래커의 메서드를 호출해 새로운 잡ID를 요청한다. 잡트래커는 잡의 출력 파일 경로가 정상적인지 확인후 잡ID를 발급한다. 참고로 JobClient와 잡트래커는 RPC로 통신하며 JobSubmissionProtocol에 정의된 프토토콜을 사용한다.
- 클라이언트는 잡을 실행하는 데 필요한 정보를 잡트래커와 태스크트래커에게 공유해야 한다. 그래서 JobClient는 입력 스플릿 정보, JobConf에 설정된 정보, 잡 클래스 파일 혹은 잡 클래스가 포함된 JAR파일을 HDFS에 저장한다.
- JobClient는 잡트래커의 submitJob 메서드를 호출해 잡 실행을 요청한다.

### 맵 리듀스 잡 실행 - 잡 초기화
- 잡트래커는 잡을 실행하기 위한 초기 설정 작업을 진행한다.
- 잡트래커는 잡의 상태와 진행 과정을 모니터링할 수 있는 JobInProgress를 생성한다. JobInProgress는 JobClient가 HDFS에 등록한 잡 공통 파일을 로컬 디스크로 복사한후, 스플릿 정보를 이용해 맵 태스크 개수와 리듀스 태스크 개수를 계산한다. 잡 실행 상태를 Running으로 설정한다.
- 잡트래커는 JobInProgress객체를 내부 큐인 jobs에 등록한다. 큐에 등록된 JobInProgress는 스케줄러에 의해 소비된다.

### 맵 리듀스 잡 실행 - 태스크 할당
- 스케쥴러가 태스크를 할당한다. 기본 스케쥴러는 FIFO방식의 스케쥴러를 이용해 잡의 실행 순서대로 태스크가 할당된다.
- 태스크 트래커는 3초에 한 번씩 잡트래커에게 하트비트 메시지를 전송하며, 이를 통해 태스크트래커가 실행 중이라는 것과 새로운 태스크를 실행할 준비가 됬다는 것을 알려준다.
- 스케줄러는 태스크트래커의 하트비트 메시지 확인후, 내부 큐에서 태스크를 할당할 잡을 선택한다. 그리고 해당 잡에서 하나의 태스크를 선택한다. 잡의 선택은 각 스케줄러의 알고리즘에 맞게 선택하게 된다.
- 스케줄러는 맵 태스크의 경우 입력 스플릿과 동일한 서버의 태스크를 선택한다. 네트워크를 통하지 않고, 로컬 디스크에 접근해서 높은 성능을 낼 수 있기 때문이다. 차선으로는 동일한 랙의 태스크를 선택한다.
- 스케줄러는 리듀스 태스크의 경우 대부분 맵 태스크의 출력 데이터를 네트워크로 내려받기 때문에 단순히 태스크 목록에 있는 순서대로 선택하게 된다.
- 스케쥴러는 태스크를 선택한후 해당 태스크트래커에게 태스크를 할당한다. 잡트래커는 태스크트래커가 전송한 하트비트의 응답으로 HeartbeatResponse를 전송한다. 잡트래커는 태스크트래커에게 지시할 내용을 HeartbeatResponse에 설절할 수 있다. 그래서 스커줄러는 HeartbeatResponse에 태스크 실행을 요청한다.

### 맵 리듀스 잡 실행 - 태스크 실행
- 태스크트래커는 할당받은 태스크를 새로운 JVM에서 실행하게 되며, 이것을 차일드JVM이라고 표현한다. 새로운 JVM에서 발생하는 버그는 태스크트래커에게 영향을 끼치지 않아서 안정적으로 태스크트래커를 운영할 수 있다. 또한 사용자가 원할 경우 재사용하게 할 수도 있다.
- TaskLauncher는 HeartbeatResponse에서 태스크 정보를 꺼내서 태스크의 상태와 진행 과정을 모니터링할 수 있는 TaskInProgress를 생성한다.
- 태스크트래커는 HDFS에 저장된 잡 공통 파일들을 로컬 디렉터리로 복사한다. 그리고 TaskInProgress는 태스크 실행 결과를 저장할 로컬 디렉터리를 생성한 후 잡 JAR파일을 디렉터리에 풀어 놓는다.
- TaskInProgress는 TaskRunner에게 태스크 실행을 요청
- TaskRunner는 JvmManager에게 차일드 JVM에서 태스크를 실행해줄 것을 요청한다.
- JvmManager는 차일드JVM을 실행한다. 차일드JVM은 TaskUmbilicalProtocol인터페이스로 부모 클래스와 통신하게 된다. 차일드JVM은 태스크가 완료될 때까지 태스크의 진행 과정을 주기적으로 JvmManager에게 알려준다. 태스크트래커는 이 정보를 공유받아 태스크의 진행 과정을 모니터링 할수 있다.

### 맵 리듀스 잡 실행 - 잡 완료
- 태스크트래커가 잡트래커가 전송하는 하트비트에는 완료된 태스크의 정보가 포함된다.
- 잡트래커는 해당 잡이 실행한 전체 태스크의 완료 정보를 받게 될 경우 JobInProgress는 잡의 상태를 SUCCEEDED로 변경한다. 만약 장애 때문에 잡이 실패했다면 잡의 상태를 FAILED로 변경
- 잡을 실행한 클라이언트와 JobClient는 잡이 완료될 떄까지 대기하고 있으며, JobClient는 잡트래커의 getJobStatus 메서드를 호출해 잡의 상태를 연속해서 확인한다. JobClient는 잡의 상태가 SUCCEED면 true를, FAILED면 false를 클라이언트에게 전달한다.

### 체인
- 하나의 맵리듀스 잡에서 여러 개의 매퍼와 리듀서를 실행할 수 있게 체인매퍼와 체인리듀서를 제공한다.

