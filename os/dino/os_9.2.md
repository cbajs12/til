# 가상 메모리

## 프레임의 할당
- OS가 모든 버퍼나 테이블 공간을 가용 프레임 리스트에서 할당받도록 할 수 있다. 이런 공간들이 OS에 의해 사용되지 않을 때는 사용자 페이징을 위해 사용될 수 있다.

### 최소로 할당해야 할 프레임의 수
- 메모리 할당에는 다양한 제약이 존재한다. 예로 페이지 공유가 없다면 총 가용 프레임 수보다 더 많이 할당할 수는 없다. 또한, 최소한 몇 페이지를 할당해야만 한다.
- 최소한의 프로세스를 가동할 수 있는 프레임을 할당해야만 하는 이유는 각 프로세스에 할당되는 프레임 수가 줄어들면 페이지 부재율은 증가하고 프로세스 실행은 늦어지게 된다. 또한, 명렁어 실행이 완료되기 전에 페이지 부재가 발생하면 그 명령어를 재실행해야 한다는 점을 기억해야 한다. 따라서 하나의 명령어가 참조하는 모든 페이지를 적재할 수 있는 충분한 프레임을 가지고 있어야 한다.
- 프로세스 당 필요한 최소 프레임 수는 컴퓨터 구조에 의해 결정된다. 예로, 모든 메모리 참조 명령어가 단 하나의 주소만을 갖는 머신이 있다면, 최소 하나의 프레임은 명령어를 위해, 또 하나의 프레임은 명령의 메모리 접근을 위해 필요하다. 여기에 한 수준의 간접 주소 지정이 가능하다면(페이지 x의 load 명령은 페이지 a 상의 주소를 참조하고, 이 주소는 페이지 y를 가리키는 간접 참조의 경우처럼) 프로세스 당 최소 3개의 다른 페이지를 담을 수 있는 프레임이 필요하다.
- 프로세스 당 최소 프레임 수는 구조에 의해 결정되고, 최대 할당 수는 가용 물리 메모리에 의해 결정된다.

### 할당 알고리즘
- m개의 프레임을 n개의 프로세스에게 할당하는 간단한 방법은 모든 프로세스에게 똑같이 m/n 프레임을 할당해 주는 것이다. 이러한 방법은 `균등 할당`이라 한다.
- 다른 대안은 프로세스마다 요구하는 메모리의 크기가 다르다는 점을 감안한 것이다. 이 방법은 가용 메모리를 각 프로세스의 크기에 맞추어 할당하는 방법인 `비례 할당` 방식이다.
- 균등과 비례 할당은 모두 높은 우선순위의 프로세스와 낮은 우선순위의 프로세스를 동등하게 취급하는 것에 유의해야 한다.
- 우선순위가 낮은 프로세스에게 손실을 주더라도 우선순위가 높은 프로세스에게 더 많은 메모리를 할당하여 실행 속도를 높이고 싶다면, 비례 할당 방법을 사용하면서 할당되는 프레임 비율을 프로세스의 상대적인 크기가 아닌 우선순위에 근거하거나 크기와 우선순의 조합을 근거로 결정하는 것이다.

### 전역 대 지역 할당
- `전역 교체`는 프로세스가 교체할 프레임을 다른 프로세스에 속한 프레임을 포함한 모든 프레임을 대상으로 찾는 경우이다. 즉, 프로세스는 다른 프로세스의 프레임을 취할 수 있다.
- `지역 교체`는 각 프로세스가 자기에게 할당된 프레임들 중에서만 교체될 희생자를 선택할 수 있다.
- 전역 교체의 경우는 우선순위가 높은 프로세스가 우선순위가 낮은 프로세스의 프레임 중에서 교체할 희생자를 찾는 것이다.
- 지역 교체의 경우는 프로세스에 할당된 프레임의 수는 변하지 않는다. 전역 교체에서는 한 프레스에 할당된 프레임의 수는 바뀔 수 있다.
- 전역 교체 알고리즘의 문제점은 한 프로세스가 자신의 페이지 부재율을 조절할 수 없다는 것이다. 동일한 프로세스도 그때그때 외부적 환경에 따라 전혀 다르게 실행될 수 있다.
- 지역 교체 방법에서는 어떤 프로세스가 메모리에 유지하는 페이지 집합은 오로지 그 프로세스의 페이징 형태에만 영향을 받는다. 그러나 지역 교체 방법에서는 잘 사용되지 않는 프레임이 다른 프로세스에게 제공되지 않기 때문에 다른 프로세스의 실행을 방해할 수 있다. 따라서 일반적으로 전역 교체가 지역 교체 알고리즘보다 더 좋은 시스템 처리량을 보이며 널리 사용된다.

### 비균등 메모리 접근
- 많은 시스템에서 모든 주메모리는 동일하게 접근되지 않는다. 시스템의 CPU와 메모리의 연결 방식이 접근 속도의 차이를 만든다.
- 시스템의 보드들이 시스템 버스를 통하여 메모리에 접근하는 시스템의 경우 메모리 접근에 차이가 난다. 메모리 접근 시간이 현저하게 차이가 나는 시스템을 모두 `비균등 메모리 접근(NUMA)` 시스템이라 하고, 예외 없이 한 메인보드에 CPU와 메모리가 존재하는 시스템 보다 느리게 작동한다.
- 어느 페이지를 어느 프레임에 할당하느냐 하는 정책이 NUMA의 성능에 커다란 영향을 미친다. 이렇기 때문에 스케줄링 시스템의 수정이 필요한데, 프로세스가 실행 중인 CPU에 가능한 가까운 메모리 프레임이 할당되도록 하는 것이다.
- 스케줄러가 프로세스가 마지막으로 실행된 CPU를 추적할 수 있게 수정되고, 스케줄러는 각 프로세스를 직전에 실행된 CPU에 스케줄하고 메모리 관리 시스템은 스케줄도니 CPU와 가까운 프레임을 할당한다면, 그 결과 캐시 적중률이 높아지고 메모리 접근 시간이 감소하게 될 것이다.

## 쓰레싱
- 충분한 프레임을 할당받지 못한 프로세스는 페이지 부재가 발생할 것이다. 이때 페이지 교체가 필요하지만 이미 활발하게 사용되는 페이지들만으로 이루어져 있으므로 어떤 페이지가 교체되든 바로 다시 필요해 질 것이다. 결과적으로 바로바로 페이지 부재가 발생하고, 곧바로 읽어야할 페이지를 연속적으로 교체하게 된다. 이러한 과도한 페이징 작업을 `쓰레싱`이라고 한다.
- 어떤 프로세스가 실행보다 더 많은 시간을 페이징에 사용하고 있을 경우 쓰레싱이 발생했다고 한다.

### 쓰레싱의 원인
- OS는 CPU의 이용률을 감시한다. CPU 이용률이 너무 낮아지면 새로운 프로세스를 시스템에 추가해서 다중 프로그래밍의 정도를 높인다. 이때 전역 페이지 교체 알고리즘을 사용하여 어떤 프로세스의 페이지인지에 대한 고려 없이 교체를 실행한다.
- 한 프로세스가 더 많은 프레임을 필요로 한다면, 페이지 부재가 발생하면서 다른 프로세스에서 프레임들을 가져오기 시작한다. 그런데, 교체된 페이지들이 원래 프로세스에서 필요로 하는 것이었다면, 그 프로세스 역시 페이지 부재를 발생시키고 또 다른 프로세스에서 프레임을 가져온다. 이러한 프로세스들은 페이지 스완 인/아웃을 위해 페이징 장치를 사용해야 한다. 이 프로세스들이 페이징 장치의 큐로 진입하면서 준비완료 큐는 비게 된다. 프로세스들이 페이징 장치를 기다리는 동안 CPU 이용률은 떨어진다.
- CPU 스케줄러는 이용률이 떨어지는 것을 보고, 이용률을 높이기 위하여 새로운 프로세스를 추가하여 다중 프로그래밍의 정도를 더 높인다. 새로 시작하는 프로세스는 실행중인 프로세스들로부터 프레임을 가져오고자 하며 더 많은 페이지 부재와 더 긴 페이징 장치 대기 시간을 야기한다. 결과적으로 CPU 이용률은 더욱 떨어지고 CPU 스케줄러는 다중 프로그래밍 정도를 더욱 높이려고 한다. 결국 쓰레싱이 일어나게 되어 시스템의 처리율은 대단히 낮아지고 페이지 부재는 엄청나게 늘어난다. 그 결과, 유효 메모리 접근 시간은 증가하고 프로세스들은 페이징하는 데 시간을 다 소비하게 되어 아무런 일도 할 수 없게 된다.
- 다중 프로그래밍 정도가 높아짐에 따라 CPU의 이용률도 높아진다. 그러나 다중 프로그래밍의 정도가 그 이상으로 더 커지면 쓰레싱이 일어나게 되고 CPU의 이용률은 급격히 떨어진다. 따라서 이 지점에서는 CPU 이용률을 높이고 쓰레싱을 중지시키기 위해 다중 프로그래밍 정도를 낮춰야한다.
- 쓰레싱은 지역 교체 알고리즘이나 우선순위 교체 알고리즘을 사용하면 제한할 수 있다. 그러나 프로세스들이 쓰레싱 상태에 있게 되면, 대부분의 시간을 페이징 장치의 큐에서 보내게 된다. 페이징 장치의 평균 대기 큐의 길이는 길어지게 되고, 페이지 부재의 평균 서비스 시간 역시 길어진다. 따라서 쓰레싱을 하지 않는 프로세스들도 유효 접근 시간이 증가하게 된다.
- 쓰레싱 현상을 방지하기 위해서는 각 프로세스가 필요로 하는 개수만큼 프레임을 할당해야 한다. 이때 각 프로세스가 필요로 하는 프레임 수를 아는 방법 중 하나는 `작업 집합 방법`이다. 이 방법은 프로세스 실행의 `지역성 모델`을 정의한다.
- 지역성 모델은 프로세스는 실행해 가면서 지역에서 지역으로 이동한다고 말한다. 지역이란, 활발하게 함께 참조되는 페이지들의 집합을 의미한다. 한 프로그램은 여러 개의 지역으로 구성되어 있고, 이 지역들은 서로 겹칠 수 있다.
- 지역은 프로그램 구조나 그 자료구조에 의해 정의된다. 지역 모델은 모든 프로그램들이 이러한 기본적인 메모리 참조 구조를 가질 것이라고 말한다. 또한 이 모델은 캐싱 기법의 기본 원리이기도 하다. 특정 데이터에 대한 참조가 어떤 패턴도 없이 무작위적이라면 캐싱은 쓸모없게 된다.
- 한 프로세스에게 현재 지역을 포함하기에 충분한 프레임을 제공한다면, 이 프로세스는 현재 지역의 모든 페이지가 메모리로 올라올 때까지는 페이지 부재를 발생시키지만, 그 후에는 지역이 변경되기 전까지는 페이지 부재를 발생시키지 않는다. 필요로 하는 지역성의 크기보다 적은 프레임을 할당하게 되면, 이 프로세스는 접근해야 하는 모든 페이지를 메모리에 유지할 수 없기 때문에 지속적으로 페이지 부재를 발생시키게 된다. 즉, 쓰레싱이 일어난다.

### 작업 집합 모델
- 작업 집합 모델은 지역성을 토대로 하고 있다. 이 모델은 작업 집합 구간을 정의한다. 
- 만약 작업 집합 구간을 x라고 한다면, 기본 아이디어는 최근 참조한 페이지중 x개를 관찰하는 것이다. 한 프로세스가 최근 x개의 페이지를 참조했다면 그 안에 들어 있는 서로 다른 페이지들의 집합을 작업 집합이라고 부른다. 
- 최근 x개의 페이지에서는 중복적인 페이지도 있지만, 집합이라는 특성상 작업 집합 안에는 중복을 제거한 페이지의 번호만 들어간다. 페이지가 활발하게 사용되었다면, 작업 집합에 포함될 것이다. 페이지가 더 이상 사용되지 않게 되면 마지막 참조로부터 x번의 페이지 참조 후에는 작업 집합에서 제외된다. 따라서 이 작업 집합은 프로그램 지역성의 근사값이 된다.
- 작업 집합의 정확도는 x의 선택에 따라 좌우된다. 만약에 x값이 너무 작으면 전체 지역을 포함하지 못할 것이고, x값이 너무 크면 여러 지역성을 과도하게 수용할 것이다. 
- 일단 x가 선택되었다면, 작업 집합 모델의 사용은 간단하다. OS는 각 프로세스의 작업 집합을 감시하면서 각 프로세스에게 작업 집합 크기에 맞는 충분한 프레임을 할당한다. 이렇게 할당하고도 여분의 가용 프레임이 있다면 다른 프로세스를 시작할 수 있다. 작업 집합의 합이 증가하여 총 가용 프레임의 수를 넘게 되면, OS는 보류시킬 프로세스를 선택한다. 프로세스의 페이지는 스왑 아웃되고 사용하던 프레임들은 다른 프로세스에게 재할당된다.
- 작업 집합 전략은 가능한 최대의 다중 프로그래밍 정도를 유지하면서 쓰레싱을 방지한다. 따라서 CPU의 이용률도 최적화된다.
- 이 모델의 어려운 점은 작업 집합을 추적하는 일이다. 작업 집합 구간은 이동하는 구간이다. 매 매모리 참조마다 한쪽에서는 새로운 참조가 나타나고 다른 쪽에서는 가장 오래된 참조부터 제외된다.
- 고정 간격 타이머 인터럽트와 참조 비트를 사용하여 작업 집합 모델을 근사할 수 있다. x가 10000이고 매 5000번의 참조마다 타이머 인터럽트를 발생시킬 수 있다면, 타이머 인터럽트가 발생할 때마다 각 페이지의 현재 참조 비트의 값을 저장해 두고 참조 비트는 0으로 재설정한다. 따라서 패이지 부재가 발생하면 마지막 10000에서 15000번의 참조 사이에 그 페이지가 사용되었는가를 결정하기 위해 현재 참조 비트와 앞서 저장된 2개의 참조 비트 값을 검사할 수 있다. 만약에 그 페이지가 사용되었으면 어느 한 비트라도 1일 것이고, 사용되지 않았다면 모두 0이다. 셋 중 어느 한 비트라도 1인 페이지는 작업 집합에 속한다.
- 과거 기억 비트 수를 늘리고 타이머 인터럽트 빈도를 높이면 불확실성을 줄일 수 있다.

### 페이지 부재 빈도(PFF)
- 작업 집합 모델은 성공적이며, 작업 집합을 알고 있으면 선페이징을 할 때에는 유용하지만, 쓰레싱을 조절하는 방법으로는 적당하지 않다. PFF 방식은 보다 더 직접적으로 쓰레싱을 조절한다.
- 쓰레싱이란 페이지 부재율이 높은 것을 의미하기 때문에 페이지 부재율을 제어하기를 원한다. 이러기 위해 페이지 부재율의 상한과 하한을 정할 수 있다. 페이지 부재율이 상한을 넘으면 그 프로세스에게 프레임을 더 할당해주고, 하한보다 낮아지면 그 프로세스의 프레임 수를 줄인다. 따라서 직접적으로 부재율을 측정하고 제어함으로써 쓰레싱을 방지할 수 있다.

### 작업 집합과 페이지 부재율
- 페이지 부재율의 고점은 새 지역의 페이지들을 요구 페이징하기 시작할 때 발생한다. 일단 새 지역의 작업 집합이 메모리에 올라오고 나면 부재율은 낮아진다.
- 즉, 어떤 상승 시작점으로부터 다음 사승 시작점 까지의 시간 간격은 한 작업 집합에서 다른 작업 집합으로의 전이를 나타낸다.
